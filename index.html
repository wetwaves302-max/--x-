<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’ï½œå¯æ„›ç‰ˆï¼ˆå«æ‹¬è™Ÿï¼‰</title>
  <meta name="description" content="æ­£è² æ•¸åŠ æ¸›ä¹˜é™¤ã€é‹ç®—é †åºç·´ç¿’ï¼›å«è¨ˆåˆ†ã€éŸ³æ•ˆã€éŒ¯é¡Œè¨ºæ–·èˆ‡é¡é¡Œè¤‡ç¿’ï¼›æ‰‹æ©Ÿå‹å–„ï¼›æ‰€æœ‰ç®—å¼ä¿ç•™( )ã€‚">
  <style>
    :root{
      --bg:#fff8fb;
      --card:#ffffff;
      --primary:#ff88b3;
      --primary-2:#ffd4e4;
      --text:#333;
      --muted:#777;
      --good:#2e7d32;
      --bad:#c62828;
      --accent:#7c4dff;
      --shadow:0 10px 25px rgba(255,136,179,0.15);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family: ui-rounded, "Segoe UI", system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, var(--bg), #fff);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, #fff, var(--bg));
      padding:10px 12px 6px; box-shadow:0 4px 12px rgba(0,0,0,0.04);
    }
    .wrap{max-width:960px; margin:0 auto; padding:14px;}
    .brand{ display:flex; align-items:center; gap:10px; padding:8px 10px; }
    .brand .logo{
      width:40px; height:40px; border-radius:12px; background:var(--primary-2);
      display:grid; place-items:center; font-size:22px; box-shadow:var(--shadow);
    }
    .brand h1{font-size:18px; margin:0;}
    .brand p{margin:0; color:var(--muted); font-size:13px;}
    .bar{ width:100%; height:10px; background:#f0f0f0; border-radius:999px; overflow:hidden; margin-top:10px; }
    .bar .fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#ffa1c5); transition:width .35s ease; border-radius:999px; }
    .stats{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:#444; font-size:13px; }
    .chip{ background:#fff; padding:6px 10px; border-radius:999px; box-shadow:var(--shadow); }
    .grid{ display:grid; gap:14px; grid-template-columns:1fr; margin-top:14px; }
    @media(min-width:900px){ .grid{ grid-template-columns: 260px 1fr; } }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    .section-title{font-weight:700; margin:0 0 8px; font-size:16px;}
    .modes{ display:flex; flex-wrap:wrap; gap:8px; }
    .mode-btn{
      border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow);
      font-size:14px; cursor:pointer; transition:transform .05s ease;
    }
    .mode-btn.active{ background:var(--primary); color:#fff; }
    .mode-btn:active{ transform:scale(0.98); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .problem{
      font-size:28px; font-weight:800; letter-spacing:.5px; padding:10px 14px; border-radius:14px;
      background:linear-gradient(180deg,#fff,#fff2f6); box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; min-height:72px;
    }
    .answer-area{ display:grid; grid-template-columns:1fr; gap:10px; }
    .answer-input{
      width:100%; font-size:20px; padding:12px 14px; border-radius:12px;
      border:2px solid #eee; outline:none;
    }
    .answer-input:focus{border-color:var(--primary);}
    .keypad{ display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; }
    .key{
      padding:12px 10px; border:none; border-radius:12px; background:#fff; box-shadow:var(--shadow);
      font-size:18px; cursor:pointer;
    }
    .key:active{ transform:scale(0.98); }
    .key.primary{ background:var(--primary); color:#fff; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow);
      font-size:14px; cursor:pointer;
    }
    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.good{ background:#e6f4ea; color:var(--good); }
    .btn.bad{ background:#fdecea; color:var(--bad); }
    .feedback{
      border-left:6px solid var(--primary); background:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
      line-height:1.6; font-size:15px;
    }
    .hint{ color:#5c6bc0; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{
      display:inline-block; padding:4px 8px; background:var(--primary-2); border-radius:999px; font-size:12px;
      margin-right:6px;
    }
    .footer{ text-align:center; color:var(--muted); padding:16px 0 40px; font-size:12px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#fff; box-shadow:var(--shadow); }
    .shake{ animation:shake .3s linear; }
    @keyframes shake{
      0%{transform:translateX(0)} 25%{transform:translateX(-3px)} 50%{transform:translateX(3px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">ğŸŒ¸</div>
        <div>
          <h1>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’ï¼ˆå«æ‹¬è™Ÿï¼‰</h1>
          <p>æº«é¦¨å¯æ„›ãƒ»æ‰‹æ©Ÿå„ªå…ˆãƒ»å«ç›²é»è¨ºæ–·èˆ‡é¡é¡Œè¤‡ç¿’ âœ¨</p>
        </div>
      </div>
      <div class="bar" aria-label="progress"><div id="progressFill" class="fill" style="width:0%"></div></div>
      <div class="stats" id="stats">
        <span class="chip">é¡Œæ•¸ï¼š<b id="qCount">0</b></span>
        <span class="chip">æ­£ç¢ºï¼š<b id="qCorrect">0</b></span>
        <span class="chip">æ­£ç¢ºç‡ï¼š<b id="qRate">0%</b></span>
        <span class="chip">åˆ†æ•¸ï¼š<b id="score">0</b></span>
        <span class="chip">é€£å°ï¼š<b id="streak">0</b> ğŸ”¥</span>
        <span class="chip badge">æ¨¡å¼ï¼š<b id="modeLabel">â€”</b></span>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šæ¨¡å¼èˆ‡è¨­å®š -->
    <section class="card">
      <h2 class="section-title">ç·´ç¿’ä¸»é¡Œ</h2>
      <div class="modes" id="modes"></div>
      <hr style="border:none;height:1px;background:#f2f2f2;margin:14px 0;">
      <h2 class="section-title">å°è¨­å®š</h2>
      <div class="row" style="gap:6px 10px">
        <span class="pill">é¡Œåº«ç¯„åœï¼šâˆ’20ï½20ï¼ˆä¹˜é™¤è‡ªå‹•æŒ‘æ•´ï¼‰</span>
        <span class="pill">æ¯é¡Œ +10 / ç­”éŒ¯ âˆ’5</span>
        <span class="pill">å…¨éƒ¨ç®—å¼é¡¯ç¤ºæ¨™æº–æ‹¬è™Ÿï¼ˆå¦‚ (âˆ’1)+(-3)ã€a + (b Ã— c)ï¼‰</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnReset">é‡ç½®çµ±è¨ˆ</button>
        <button class="btn" id="btnReview" title="éŒ¯é¡Œè¤‡ç¿’ï¼ˆæœƒå‡ºåŒçµæ§‹é¡é¡Œï¼‰">é–‹å§‹éŒ¯é¡Œè¤‡ç¿’</button>
        <span class="muted" id="reviewBadge">ï¼ˆç›®å‰éŒ¯é¡Œï¼š0ï¼‰</span>
      </div>
      <p class="muted" style="margin-top:8px">ğŸ’¡ã€ŒéŒ¯é¡Œè¤‡ç¿’ã€ï¼šå…ˆé¡¯ç¤ºç›²é»ï¼Œå†å‡ºåŒçµæ§‹é¡é¡Œï¼Œå¹«ä½ è£œå¼·æ¦‚å¿µã€‚</p>
    </section>

    <!-- å³ï¼šä½œç­”å€ -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div class="problem" id="problem">è«‹å…ˆé¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œ ğŸ‘ˆ</div>
        <div class="row" style="gap:6px">
          <button class="btn" id="btnPrev" disabled>ä¸Šä¸€é¡Œ</button>
          <button class="btn" id="btnNext" disabled>ä¸‹ä¸€é¡Œ</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr; margin-top:12px">
        <div class="answer-area">
          <input id="answer" class="answer-input" inputmode="numeric" placeholder="åœ¨é€™è£¡è¼¸å…¥ç­”æ¡ˆï¼ˆå¯ç”¨ä¸‹æ–¹éµç›¤ï¼‰" />
          <div class="keypad" id="keypad"></div>
          <div class="controls">
            <button class="btn" id="btnSkip">ç•¥é</button>
            <button class="btn primary" id="btnSubmit">é€å‡º</button>
          </div>
          <div id="feedback" class="feedback" style="display:none"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Â© 2025 æ­£è² æ•¸å°å®‡å®™ Â· ç‚ºå­¸ç¿’åŠ æ²¹ ğŸ’—</div>

  <script>
    /***************
     * å¯èª¿æ•´åƒæ•¸  *
     ***************/
    const SCORE_CORRECT = 10;
    const SCORE_WRONG = 5; // æ‰£åˆ†
    const PROGRESS_TARGET = 20; // é€²åº¦æ¢æ»¿æ ¼åŸºæº–

    /***************
     * ç‹€æ…‹ç®¡ç†     *
     ***************/
    const state = {
      mode: null,
      history: [], // {displayExpr, evalExpr, answer, user, correct, explain, structure}
      pointer: -1,
      score: 0,
      streak: 0,
      reviewQueue: [],
    };

    const Modes = [
      { id:'addsub', label:'â‘  æ­£è² æ•¸åŠ æ¸› â•â–' },
      { id:'muldiv', label:'â‘¡ æ­£è² æ•¸ä¹˜é™¤ âœ–ï¸â—' },
      { id:'mixed',  label:'â‘¢ æ­£è² æ•¸å››å‰‡æ··åˆ ğŸ”€' },
      { id:'preced', label:'â‘£ å…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸› âš–ï¸' },
    ];

    /***************
     * å°å·¥å…·       *
     ***************/
    const $ = sel => document.querySelector(sel);
    const elModes = $('#modes');
    const elProblem = $('#problem');
    const elAnswer = $('#answer');
    const elKeypad = $('#keypad');
    const elFeedback = $('#feedback');

    const elQCount = $('#qCount');
    const elQCorrect = $('#qCorrect');
    const elQRate = $('#qRate');
    const elScore = $('#score');
    const elStreak = $('#streak');
    const elModeLabel = $('#modeLabel');
    const elProgressFill = $('#progressFill');
    const elReviewBadge = $('#reviewBadge');

    const elBtnPrev = $('#btnPrev');
    const elBtnNext = $('#btnNext');
    const elBtnReset = $('#btnReset');
    const elBtnReview = $('#btnReview');
    const elBtnSkip = $('#btnSkip');
    const elBtnSubmit = $('#btnSubmit');

    function clampInt(n){ return (n|0); }
    function randInt(a,b){ return clampInt(Math.floor(Math.random()*(b-a+1))+a); }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // âœ… UPDATED: å°‡æ•¸å­—ä»¥ã€Œæ‹¬è™Ÿ + è² è™Ÿå‰ç½®ã€çš„å½¢å¼å‘ˆç¾
    function fmtNumForDisplay(n){
      if(n<0) return `(${n})`;           // ä¾‹å¦‚ (-3)
      if(n>=0) return `(${n})`;          // æ­£æ•¸ä¹Ÿä¿ç•™æ‹¬è™Ÿï¼Œçµ±ä¸€ç´™ç­†æ¨£å¼
      return `(${n})`;
    }

    // âœ… UPDATED: å»ºç«‹é¡¯ç¤ºç”¨èˆ‡è¨ˆç®—ç”¨çš„é‹ç®—å­
    function dispOp(op){ return op; }
    function evalOp(op){ return op.replace('Ã—','*').replace('Ã·','/'); }

    function playTone(ok=true){
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = ok ? 'sine' : 'square';
      o.frequency.value = ok ? 880 : 220;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      o.start();
      const dur = ok ? 0.12 : 0.18;
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
      o.stop(ctx.currentTime+dur+0.01);
    }

    function updateStats(){
      const total = state.history.length;
      const correct = state.history.filter(h=>h.correct).length;
      const rate = total? Math.round(correct*100/total):0;
      elQCount.textContent = total;
      elQCorrect.textContent = correct;
      elQRate.textContent = rate + '%';
      elScore.textContent = state.score;
      elStreak.textContent = state.streak;
      const fill = Math.min(100, Math.round((total/PROGRESS_TARGET)*100));
      elProgressFill.style.width = fill + '%';
      elReviewBadge.textContent = `ï¼ˆç›®å‰éŒ¯é¡Œï¼š${state.reviewQueue.length}ï¼‰`;
      elModeLabel.textContent = state.mode ? Modes.find(m=>m.id===state.mode).label : 'â€”';
      localStorage.setItem('int_arith_state_v2', JSON.stringify(state, (k,v)=> k==='history' ? v.slice(-200) : v));
    }

    function loadPersist(){
      try{
        const s = JSON.parse(localStorage.getItem('int_arith_state_v2')||'null');
        if(!s) return;
        Object.assign(state, s);
        updateStats();
      }catch(e){}
    }

    /*****************
     * é¡Œç›®ç”¢ç”Ÿå™¨     *
     *****************/
    function makeRecord({displayExpr, evalExpr, answer, structure}){
      return {displayExpr, evalExpr, answer, user:null, correct:null, explain:null, structure};
    }

    // äºŒå…ƒåŠ æ¸›
    function genAddSub(){
      const a = randInt(-20,20);
      const b = randInt(-20,20);
      const op = choice(['+','-']);
      const displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op)} ${fmtNumForDisplay(b)}`; // âœ… æ‹¬è™ŸåŒ–
      const evalExpr = `${a} ${evalOp(op)} ${b}`;
      const answer = Function(`"use strict";return (${evalExpr});`)();
      return makeRecord({displayExpr, evalExpr, answer, structure:{kind:'bin', op, a, b}});
    }

    // äºŒå…ƒä¹˜é™¤ï¼ˆæ•´æ•¸çµæœï¼‰
    function genMulDiv(){
      let b = 0;
      while(b===0) b = randInt(-12,12);
      const op = choice(['Ã—','Ã·']);
      let a, answer, evalExpr;
      if(op==='Ã—'){
        a = randInt(-12,12);
        evalExpr = `${a} * ${b}`;
        answer = a*b;
      }else{
        const res = randInt(-12,12) || 1;
        answer = res;
        a = res*b;
        evalExpr = `${a} / ${b}`;
      }
      const displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op)} ${fmtNumForDisplay(b)}`; // âœ… æ‹¬è™ŸåŒ–
      return makeRecord({displayExpr, evalExpr, answer, structure:{kind:'bin', op, a, b}});
    }

    // ä¸‰é …æ··åˆï¼ˆæ¨™ç¤ºéœ€è¦å…ˆç®—çš„éƒ¨åˆ†ï¼‰
    function genMixed(){
      const ops = ['+','-','Ã—','Ã·'];
      let op1 = choice(ops), op2 = choice(ops);
      // é™ä½é€£çºŒé™¤æ³•çš„æ©Ÿç‡
      if(op1==='Ã·') op2 = choice(['+','-','Ã—']);

      let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
      if(b===0 && op1==='Ã·') b=choice([-3,-2,-1,1,2,3]);
      if(c===0 && op2==='Ã·') c=choice([-3,-2,-1,1,2,3]);

      // ç¢ºä¿æ•´æ•¸ï¼šè‹¥æœ‰é™¤æ³•ï¼Œåšäº›å›æ¨
      if(op1==='Ã·'){ const res = randInt(-10,10) || 1; a = res * (b||1); }
      if(op2==='Ã·'){
        let res2 = randInt(-10,10) || 1;
        c = (c===0? 1 : c);
        let left = res2 * c;
        // è®“ (a op1 b) = left
        op1 = choice(['+','-','Ã—']); // ç°¡åŒ–è™•ç†
        if(op1==='+') a = left - b;
        else if(op1==='-') a = left + b;
        else if(op1==='Ã—'){ a = (b===0? left : (left/(b||1))); if(!Number.isInteger(a)){ a = left; b=1; } }
      }

      const evalExpr = `${a} ${evalOp(op1)} ${b} ${evalOp(op2)} ${c}`;
      const answer = Function(`"use strict";return (${evalExpr});`)();

      // âœ… UPDATED: é¡¯ç¤ºè¡¨é”å¼â€”â€”ç”¨æ‹¬è™Ÿæ¨™ç¤ºå„ªå…ˆè¨ˆç®—çš„éƒ¨åˆ†
      let displayExpr = '';
      const multDiv = x => (x==='Ã—'||x==='Ã·');

      if( multDiv(op2) && !multDiv(op1) ){
        // a (+/-) (b Ã—/Ã· c)
        displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} (${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)})`;
      }else if( multDiv(op1) && !multDiv(op2) ){
        // (a Ã—/Ã· b) (+/-) c
        displayExpr = `(${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)}) ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
      }else{
        // éƒ½æ˜¯åŠ æ¸›æˆ–éƒ½æ˜¯ä¹˜é™¤ï¼šç‚ºæ¸…æ™°èµ·è¦‹ï¼Œä¹Ÿå¯åŠ å¤–å±¤å°æ‹¬è™Ÿä»¥æ¨¡æ“¬æ­¥é©Ÿ
        if(multDiv(op1) && multDiv(op2)){
          // (a op1 b) op2 c â€”â€” ç¿’æ…£å·¦çµåˆ
          displayExpr = `(${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)}) ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
        }else{
          // åŠ æ¸›å…©æ­¥ï¼Œä»ä¿ç•™æ¯å€‹æ•¸çš„æ‹¬è™Ÿ
          displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
        }
      }

      return makeRecord({displayExpr, evalExpr, answer, structure:{kind:'tri', op1, op2, a, b, c}});
    }

    // é‹ç®—é †åºæ¨¡å¼ï¼ša (+/-) (b Ã—/Ã· c)
    function genPrecedence(){
      let a = randInt(-15,15), b = randInt(-10,10), c = randInt(-10,10);
      let op1 = choice(['+','-']);
      let op2 = choice(['Ã—','Ã·']);
      if(op2==='Ã·'){ if(c===0) c=choice([-3,-2,-1,1,2,3]); b = (randInt(-8,8)||1) * c; }
      const evalExpr = `${a} ${evalOp(op1)} ${b} ${evalOp(op2)} ${c}`;
      const answer = Function(`"use strict";return (${evalExpr});`)();
      // âœ… UPDATED: å›ºå®šä»¥æ‹¬è™Ÿé¡¯ç¤ºã€Œå…ˆä¹˜é™¤ã€çš„ç¾¤çµ„
      const displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} (${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)})`;
      return makeRecord({displayExpr, evalExpr, answer, structure:{kind:'preced', op1, op2, a, b, c}});
    }

    function genQuestion(){
      if(state.mode==='addsub') return genAddSub();
      if(state.mode==='muldiv') return genMulDiv();
      if(state.mode==='mixed')  return genMixed();
      if(state.mode==='preced') return genPrecedence();
      return null;
    }

    /*****************
     * ç›²é»è¨ºæ–·       *
     *****************/
    function diagnose(struct, correctAns, userAns){
      const tips = [];
      const delta = userAns - correctAns;

      if(struct.kind==='bin'){
        const {op, a, b} = struct;
        if(op==='+' || op==='-'){
          tips.push('åŠ æ¸›æ™‚ï¼šåŒè™Ÿå…ˆåŠ å¾Œä¿ç¬¦è™Ÿï¼›ç•°è™Ÿå…ˆæ¯”å¤§å°å†ç›¸æ¸›ï¼Œå–è¼ƒå¤§æ•¸çš„ç¬¦è™Ÿã€‚æŠŠè² æ•¸ç”¨æ‹¬è™Ÿå¯«æ¸…æ¥šï¼Œä¾‹å¦‚ï¼š(-5) âˆ’ (-3) = (-5) + 3ã€‚');
          // å¸¸è¦‹ï¼šæŠŠã€Œæ¸›è² æ•¸ã€çœ‹æˆã€Œæ¸›æ­£æ•¸ã€
          if(op==='-' && b<0){
            tips.push('ä½ å¯èƒ½æŠŠã€Œæ¸›è² æ•¸ã€çœ‹æˆã€Œæ¸›æ­£æ•¸ã€ã€‚æé†’ï¼ša âˆ’ (âˆ’b) = a + bã€‚');
          }
          if(op==='+' && b<0){
            tips.push('ä½ å¯èƒ½å¿½ç•¥äº†åŠ æ•¸çš„è² è™Ÿã€‚è«‹ç”¨æ‹¬è™Ÿï¼ša + (âˆ’b)ã€‚');
          }
        }else{ // ä¹˜é™¤
          const signOk = Math.sign(userAns) === Math.sign(correctAns) || userAns===0 || correctAns===0;
          if(!signOk){
            tips.push('ä¹˜é™¤çš„æ­£è² è¦å‰‡ï¼šåŒè™Ÿå¾—æ­£ã€ç•°è™Ÿå¾—è² ã€‚è«‹å…ˆåˆ¤æ–·ç¬¦è™Ÿï¼Œå†ç®—æ•¸å€¼ã€‚');
          }
          tips.push('å»ºè­°ï¼šå…ˆå¯«å‡ºç¬¦è™Ÿï¼Œå†åšä¹˜é™¤ï¼›æœ€å¾ŒæŠŠç¬¦è™Ÿèˆ‡æ•¸å€¼ä¸€ä½µå¸¶å›ç­”æ¡ˆã€‚');
        }
      }else if(struct.kind==='preced'){
        tips.push('ä½ å¯èƒ½å¿½ç•¥äº†ã€Œå…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸›ã€ã€‚è«‹å…ˆæŠŠä¹˜é™¤éƒ¨åˆ†ç”¨æ‹¬è™Ÿåœˆå‡ºå†ç®—ï¼Œä¾‹å¦‚ï¼ša + (b Ã— c)ã€‚');
      }else if(struct.kind==='tri'){
        tips.push('æœ‰å…©å€‹é‹ç®—æ™‚ï¼Œå‹™å¿…å…ˆè™•ç†ä¹˜é™¤ï¼Œå†åšåŠ æ¸›ã€‚å¯æŠŠå…ˆç®—çš„éƒ¨åˆ†ç”¨æ‹¬è™Ÿæ¨™ç¤ºï¼Œå¦‚ï¼š(a Ã— b) + c æˆ– a âˆ’ (b Ã· c)ã€‚');
      }

      if(Math.abs(delta)===1){
        tips.push('ä½ çš„ç­”æ¡ˆåªå·® 1ï¼Œå¯èƒ½æ˜¯æœ€å¾Œä¸€æ­¥æŠ„å¯«æˆ–åŠ æ¸›æ™‚çš„å°å¤±èª¤ï¼Œé‡ç®—æœ€å¾Œå…©æ­¥ã€‚');
      }
      tips.push('å°æ’‡æ­¥ï¼šæ‰€æœ‰è² æ•¸èˆ‡ä¸­é–“çµæœéƒ½ç”¨æ‹¬è™ŸåŒ…èµ·ä¾†ï¼ˆä¾‹å¦‚ (âˆ’3)ã€(4 Ã— (âˆ’2) )ï¼‰ï¼Œèƒ½å¤§å¹…æ¸›å°‘çœ‹éŒ¯è™Ÿçš„æƒ…æ³ã€‚');
      return tips;
    }

    /*****************
     * é¡é¡Œç”¢ç”Ÿ       *
     *****************/
    function similarQuestion(struct){
      if(struct.kind==='bin'){
        const {op, a, b} = struct;
        let a2 = randInt(-12,12), b2 = randInt(-12,12);
        // ç¶­æŒç¬¦è™Ÿå‹æ…‹ï¼ˆæ­£/è² ï¼‰
        if(a!==0) a2 = Math.abs(a2) * Math.sign(a);
        if(b!==0) b2 = Math.abs(b2) * Math.sign(b);
        if(op==='Ã·' && b2===0) b2 = choice([-3,-2,-1,1,2,3]);
        const displayExpr = `${fmtNumForDisplay(a2)} ${dispOp(op)} ${fmtNumForDisplay(b2)}`;
        const evalExpr = `${a2} ${evalOp(op)} ${b2}`;
        const answer = Function(`"use strict";return (${evalExpr});`)();
        return {displayExpr, answer, evalExpr};
      }
      if(struct.kind==='preced'){
        let {op1, op2} = struct;
        let a = randInt(-15,15), b = randInt(-10,10), c = randInt(-10,10);
        if(op2==='Ã·'){ if(c===0) c=choice([-3,-2,-1,1,2,3]); b = (randInt(-8,8)||1) * c; }
        const displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} (${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)})`;
        const evalExpr = `${a} ${evalOp(op1)} ${b} ${evalOp(op2)} ${c}`;
        const answer = Function(`"use strict";return (${evalExpr});`)();
        return {displayExpr, answer, evalExpr};
      }
      if(struct.kind==='tri'){
        let {op1, op2} = struct;
        let a = randInt(-10,10), b = randInt(-10,10), c = randInt(-10,10);
        if(op1==='Ã·' && b===0) b=choice([-3,-2,-1,1,2,3]);
        if(op2==='Ã·' && c===0) c=choice([-3,-2,-1,1,2,3]);
        const multDiv = x => (x==='Ã—'||x==='Ã·');
        let displayExpr = '';
        if( multDiv(op2) && !multDiv(op1) ){
          displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} (${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)})`;
        }else if( multDiv(op1) && !multDiv(op2) ){
          displayExpr = `(${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)}) ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
        }else if( multDiv(op1) && multDiv(op2) ){
          displayExpr = `(${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)}) ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
        }else{
          displayExpr = `${fmtNumForDisplay(a)} ${dispOp(op1)} ${fmtNumForDisplay(b)} ${dispOp(op2)} ${fmtNumForDisplay(c)}`;
        }
        const evalExpr = `${a} ${evalOp(op1)} ${b} ${evalOp(op2)} ${c}`;
        const answer = Function(`"use strict";return (${evalExpr});`)();
        return {displayExpr, answer, evalExpr};
      }
      // fallback
      const q = genQuestion();
      return {displayExpr:q.displayExpr, answer:q.answer, evalExpr:q.evalExpr};
    }

    /*****************
     * å‘ˆç¾èˆ‡äº’å‹•     *
     *****************/
    function setProblem(text){ elProblem.textContent = text; }

    function setFeedback(html, good=false, show=true){
      if(!show){ elFeedback.style.display='none'; return; }
      elFeedback.innerHTML = html;
      elFeedback.style.display = 'block';
      if(!good){ elFeedback.classList.add('shake'); setTimeout(()=>elFeedback.classList.remove('shake'), 300); }
    }

    function pushHistory(item){
      state.history.push(item);
      state.pointer = state.history.length - 1;
    }

    function showCurrent(){
      const h = state.history[state.pointer];
      if(!h){ return; }
      setProblem(h.displayExpr);
      elAnswer.value = '';
      setFeedback('', false, false);
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = (state.pointer>=state.history.length-1);
    }

    function newQuestion(fromReview=false){
      if(!state.mode && !fromReview){ return; }
      const q = genQuestion();
      setProblem(q.displayExpr);
      elAnswer.value = '';
      setFeedback('', false, false);
      pushHistory(q);
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = true;
      updateStats();
    }

    function startReview(){
      if(state.reviewQueue.length===0){
        setFeedback('ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯ä»¥è¤‡ç¿’ï¼Œå…ˆåšå¹¾é¡Œå†å›ä¾†å§ ğŸŒ±', true, true);
        return;
      }
      const struct = state.reviewQueue.shift();
      const sim = similarQuestion(struct);
      setProblem(sim.displayExpr + 'ï¼ˆé¡é¡Œï¼‰');
      elAnswer.value = '';
      setFeedback('<span class="hint">é€™é¡Œæ˜¯ä¾ç…§ä½ çš„éŒ¯èª¤é¡å‹å‡ºçš„ã€Œé¡é¡Œã€ã€‚å…ˆä¾æç¤ºæ€è€ƒï¼Œå†è©¦ä¸€æ¬¡ï¼</span>', true, true);
      pushHistory({displayExpr:sim.displayExpr, evalExpr:sim.evalExpr, answer:sim.answer, user:null, correct:null, explain:'ï¼ˆé¡é¡Œç·´ç¿’ï¼‰', structure:struct});
      updateStats();
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = true;
    }

    function submit(){
      const h = state.history[state.pointer];
      if(!h){ return; }
      const raw = elAnswer.value.trim();
      if(!raw){ elAnswer.focus(); return; }
      const user = Number(raw);
      const correct = (user === h.answer);
      h.user = user;
      h.correct = correct;

      if(correct){
        playTone(true);
        state.score += SCORE_CORRECT;
        state.streak += 1;
        setFeedback(`âœ… <b>ç­”å°äº†ï¼</b> ${h.displayExpr} = <b>${h.answer}</b><br><span class="muted">å¤ªæ£’äº†ï½ç¹¼çºŒä¿æŒï¼</span>`, true, true);
      }else{
        playTone(false);
        state.score -= SCORE_WRONG;
        state.streak = 0;
        const tips = diagnose(h.structure || {kind:'bin'}, h.answer, user);
        h.explain = tips.join('<br>');
        if(h.structure) state.reviewQueue.push(h.structure);
        setFeedback(`âŒ <b>å¯æƒœï¼</b> æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${h.answer}</b><br><br>
        <b>ç›²é»è¨ºæ–·ï¼š</b><br>${tips.map(t=>`â€¢ ${t}`).join('<br>')}<br><br>
        <span class="hint">ğŸ‘‰ å°ç·´ç¿’ï¼šé»ã€Œé–‹å§‹éŒ¯é¡Œè¤‡ç¿’ã€æœƒå‡ºåŒçµæ§‹çš„é¡é¡Œå–”ï¼</span>`, false, true);
      }
      elBtnNext.disabled = false;
      updateStats();
    }

    /*****************
     * äº‹ä»¶ç¶å®š       *
     *****************/
    function buildModeButtons(){
      Modes.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'mode-btn';
        b.textContent = m.label;
        b.addEventListener('click', ()=>{
          document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          state.mode = m.id;
          state.streak = 0;
          setFeedback('å·²åˆ‡æ›æ¨¡å¼ï¼Œé–‹å§‹æ–°ä¸€é¡Œå§ï¼', true, true);
          newQuestion();
          updateStats();
        });
        elModes.appendChild(b);
      });
    }

    function buildKeypad(){
      const keys = [
        '7','8','9','âŒ«',
        '4','5','6','æ¸…é™¤',
        '1','2','3','âˆ’',
        '0','00','Â±','é€å‡º'
      ];
      keys.forEach(k=>{
        const btn = document.createElement('button');
        btn.className = 'key' + (k==='é€å‡º' ? ' primary':'');
        btn.textContent = k;
        btn.addEventListener('click', ()=>{
          if(k==='é€å‡º'){ submit(); return; }
          if(k==='æ¸…é™¤'){ elAnswer.value=''; return; }
          if(k==='âŒ«'){ elAnswer.value = elAnswer.value.slice(0,-1); return; }
          if(k==='âˆ’'){
            if(elAnswer.value.startsWith('-')) return;
            elAnswer.value = '-' + elAnswer.value;
            return;
          }
          if(k==='Â±'){
            if(elAnswer.value.startsWith('-')) elAnswer.value = elAnswer.value.slice(1);
            else elAnswer.value = (elAnswer.value? ('-'+elAnswer.value) : '-');
            return;
          }
          elAnswer.value += k;
        });
        elKeypad.appendChild(btn);
      });
    }

    elBtnSubmit.addEventListener('click', submit);
    elBtnSkip.addEventListener('click', ()=>{ newQuestion(); });
    elBtnPrev.addEventListener('click', ()=>{ if(state.pointer>0){ state.pointer--; showCurrent(); } });
    elBtnNext.addEventListener('click', ()=>{
      if(state.pointer < state.history.length-1){ state.pointer++; showCurrent(); }
      else { newQuestion(); }
    });
    elBtnReset.addEventListener('click', ()=>{
      if(confirm('ç¢ºå®šè¦é‡ç½®çµ±è¨ˆèˆ‡é€²åº¦å—ï¼Ÿï¼ˆä¸æœƒåˆªé™¤é¡Œç›®å…§å®¹ï¼‰')){
        state.history=[]; state.pointer=-1; state.score=0; state.streak=0; state.reviewQueue=[];
        setProblem('å·²é‡ç½®ï¼Œè«‹é¸æ“‡ä¸»é¡Œæˆ–æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ã€‚');
        setFeedback('', false, false);
        updateStats();
        elBtnPrev.disabled = true; elBtnNext.disabled = true;
      }
    });
    elBtnReview.addEventListener('click', startReview);

    elAnswer.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submit(); } });

    // åˆå§‹åŒ–
    buildModeButtons();
    buildKeypad();
    loadPersist();
    updateStats();

    if(!state.mode){
      setFeedback('è«‹å…ˆåœ¨å·¦å´é¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œï¼ˆä¾‹å¦‚ã€Œâ‘  æ­£è² æ•¸åŠ æ¸›ã€ï¼‰ï¼Œå†é–‹å§‹ä½œç­”ã€‚', true, true);
    }else{
      newQuestion();
    }
  </script>
</body>
</html>
