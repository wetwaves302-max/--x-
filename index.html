<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ­£è² æ•¸å››å‰‡é‹ç®—ï½œæ‰‹æ©Ÿå‹å–„ï¼ˆå«è¨ˆæ™‚èˆ‡éŒ¯é¡Œè¤‡ç¿’ï¼‰</title>
<meta name="description" content="æ­£è² æ•¸åŠ æ¸›ä¹˜é™¤ç·´ç¿’ï¼›å«è¨ˆæ™‚æ¨¡å¼ã€éŸ³æ•ˆã€è¨ˆåˆ†ã€é€²åº¦æ¢ã€éŒ¯é¡Œè¤‡ç¿’èˆ‡ç›²é»è¨ºæ–·ï¼›åƒ…ç”¨ ( ) èˆ‡ [ ] æ‹¬è™Ÿï¼›æ‰‹æ©Ÿå‹å–„ã€‚">
<style>
  :root{
    --bg:#fff8fb; --card:#ffffff; --ink:#333; --muted:#6b7280;
    --p:#ff8bb6; --p2:#ffd6e7; --good:#2e7d32; --bad:#c62828;
    --shadow:0 10px 24px rgba(255,139,182,.15); --r:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-rounded,"Segoe UI",-apple-system,"PingFang TC","Noto Sans TC",sans-serif;background:linear-gradient(#fff,var(--bg));color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,var(--bg));box-shadow:0 4px 16px rgba(0,0,0,.04)}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  .brand{display:flex;gap:10px;align-items:center;padding:8px 10px}
  .logo{width:42px;height:42px;border-radius:14px;background:var(--p2);display:grid;place-items:center;font-size:22px;box-shadow:var(--shadow)}
  .brand h1{margin:0;font-size:18px}
  .brand p{margin:0;color:var(--muted);font-size:13px}

  .pill{display:inline-block;margin:4px 6px 0 0;padding:4px 10px;border-radius:999px;background:#ffe5ef;font-size:12px}
  .bar{width:100%;height:10px;background:#f0f0f0;border-radius:999px;overflow:hidden;margin-top:10px}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--p),#ffa1c5);transition:width .35s;border-radius:999px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;color:#444;font-size:13px}
  .chip{background:#fff;padding:6px 10px;border-radius:999px;box-shadow:var(--shadow)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;box-shadow:var(--shadow)}

  .grid{display:grid;gap:14px;grid-template-columns:1fr;margin-top:14px}
  @media(min-width:900px){.grid{grid-template-columns:280px 1fr}}

  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
  .section-title{margin:0 0 8px;font-weight:700;font-size:16px}

  .mode-btn{border:none;border-radius:12px;padding:10px 12px;background:#fff;box-shadow:var(--shadow);font-size:14px;cursor:pointer;margin:4px 6px 0 0}
  .mode-btn.active{background:var(--p);color:#fff}

  .problem{font-size:26px;font-weight:800;letter-spacing:.4px;padding:12px 14px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff2f6);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;min-height:72px;word-break:break-word}
  .answer-input{width:100%;font-size:20px;padding:12px 14px;border-radius:12px;border:2px solid #eee;outline:none}
  .answer-input:focus{border-color:var(--p)}

  .keypad{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .key{padding:12px 10px;border:none;border-radius:12px;background:#fff;box-shadow:var(--shadow);font-size:18px;cursor:pointer}
  .key.primary{background:var(--p);color:#fff}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{border:none;border-radius:12px;padding:10px 12px;background:#fff;box-shadow:var(--shadow);font-size:14px;cursor:pointer}
  .btn.primary{background:var(--p);color:#fff}

  .feedback{border-left:6px solid var(--p);background:#fff;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);line-height:1.6;font-size:15px;margin-top:8px}
  .muted{color:var(--muted);font-size:12px}
  .step{padding:6px 10px;background:#fafafa;border-radius:10px;margin:6px 0;border:1px dashed #eee}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#f7f7f7;border:1px solid #e5e5e5;border-radius:6px;padding:0 6px}
  .shake{animation:shake .3s linear}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}

  .hint{color:#5c6bc0}
  .footer{text-align:center;color:var(--muted);padding:16px 0 40px;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">ğŸŒ¸</div>
      <div>
        <h1>æ­£è² æ•¸å››å‰‡é‹ç®—ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰</h1>
        <p>æ¨¡å¼ï¼šâ‘ æ­£è² åŠ æ¸› â‘¡æ­£è² ä¹˜é™¤ â‘¢å››å‰‡æ··åˆ â‘£å…ˆä¹˜é™¤å¾ŒåŠ æ¸›ï½œæ‹¬è™Ÿåƒ…ç”¨ ( ) èˆ‡ [ ]</p>
      </div>
    </div>

    <!-- è¦å‰‡æç¤ºï¼ˆé†’ç›®ï¼‰ -->
    <div class="card" style="padding:10px 12px">
      <div class="section-title">å››å‰‡é‹ç®—åŸå‰‡</div>
      <div class="muted">å…ˆæ‹¬è™Ÿ â†’ å†ä¹˜é™¤ â†’ å†åŠ æ¸›ï¼ˆåŒå±¤ç”±å·¦åˆ°å³ï¼‰</div>
      <div class="pill">æ‹¬è™Ÿé †åºï¼šå…ˆ <span class="kbd">( )</span> â†’ å† <span class="kbd">[ ]</span></div>
      <div class="pill">å°æŠ€å·§ï¼šè² æ•¸å¯«æˆ <span class="kbd">(-3)</span> æ¯”è¼ƒä¸æœƒçœ‹éŒ¯è™Ÿ</div>
    </div>

    <div class="bar" aria-label="progress"><div id="progressFill" class="fill"></div></div>
    <div class="stats">
      <span class="chip">é¡Œæ•¸ï¼š<b id="qCount">0</b></span>
      <span class="chip">æ­£ç¢ºï¼š<b id="qCorrect">0</b></span>
      <span class="chip">æ­£ç¢ºç‡ï¼š<b id="qRate">0%</b></span>
      <span class="chip">åˆ†æ•¸ï¼š<b id="score">0</b></span>
      <span class="chip">é€£å°ï¼š<b id="streak">0</b> ğŸ”¥</span>
      <span class="badge">æ¨¡å¼ï¼š<b id="modeLabel">â€”</b></span>
      <span class="badge">â± è¨ˆæ™‚ï¼š<b id="timerText">æœªé–‹å§‹</b></span>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- å·¦ï¼šæ¨¡å¼èˆ‡è¨­å®š -->
  <section class="card">
    <div class="section-title">é¸æ“‡ç·´ç¿’ä¸»é¡Œ</div>
    <div id="modes"></div>
    <div class="pill">é…åˆ†ï¼šç­”å° +10ã€ç­”éŒ¯ âˆ’5</div>
    <div class="pill">é€²åº¦æ¢æœƒä¾å·²ä½œé¡Œæ•¸å¢åŠ </div>
    <hr style="border:none;height:1px;background:#f2f2f2;margin:12px 0">
    <div class="section-title">è¨ˆæ™‚æŒ‘æˆ°</div>
    <div class="controls">
      <button class="btn" id="btnTimer60">é–‹å§‹ 60s</button>
      <button class="btn" id="btnTimer120">é–‹å§‹ 120s</button>
      <button class="btn" id="btnStopTimer">åœæ­¢</button>
    </div>
    <hr style="border:none;height:1px;background:#f2f2f2;margin:12px 0">
    <div class="controls">
      <button class="btn" id="btnReview">é–‹å§‹éŒ¯é¡Œè¤‡ç¿’</button>
      <button class="btn" id="btnReset">é‡ç½®çµ±è¨ˆ</button>
    </div>
  </section>

  <!-- å³ï¼šä½œç­”å€ -->
  <section class="card">
    <div class="problem" id="problem">è«‹å…ˆé¸æ“‡å·¦å´çš„ç·´ç¿’ä¸»é¡Œ ğŸ‘ˆ</div>
    <input id="answer" class="answer-input" inputmode="numeric" placeholder="åœ¨é€™è£¡è¼¸å…¥ç­”æ¡ˆï¼ˆå¯ç”¨ä¸‹æ–¹éµç›¤ï¼‰" />
    <div class="keypad" id="keypad"></div>
    <div class="controls">
      <button class="btn" id="btnPrev" disabled>ä¸Šä¸€é¡Œ</button>
      <button class="btn" id="btnNext" disabled>ä¸‹ä¸€é¡Œ</button>
      <button class="btn primary" id="btnSubmit">é€å‡º</button>
      <button class="btn" id="btnSkip">ç•¥é</button>
    </div>
    <div id="feedback" class="feedback" style="display:none"></div>
  </section>
</main>

<div class="footer">Â© 2025 æ­£è² æ•¸å°å®‡å®™ Â· æº«é¦¨å¯æ„›ã€å……æ»¿å¸Œæœ› ğŸ’—</div>

<script>
/* ===== å¯èª¿åƒæ•¸ ===== */
const SCORE_CORRECT = 10;
const SCORE_WRONG = 5;
const PROGRESS_TARGET = 20;

/* ===== ç‹€æ…‹ ===== */
const state = {
  mode:null,
  history:[],   // {displayExpr, evalExpr, answer, user, correct, explain, structure}
  pointer:-1,
  score:0,
  streak:0,
  reviewQueue:[],
  timer:null,
  timeLeft:0,
  timerMode:false
};

/* ===== DOM ===== */
const $ = s=>document.querySelector(s);
const elProblem = $('#problem'), elAnswer = $('#answer'), elFeedback = $('#feedback'), elKeypad = $('#keypad');
const elQCount = $('#qCount'), elQCorrect = $('#qCorrect'), elQRate = $('#qRate'), elScore = $('#score'), elStreak = $('#streak');
const elModeLabel = $('#modeLabel'), elProgressFill = $('#progressFill'), elTimerText = $('#timerText');
const elBtnPrev = $('#btnPrev'), elBtnNext = $('#btnNext'), elBtnSubmit = $('#btnSubmit'), elBtnSkip = $('#btnSkip');
const elBtnReview = $('#btnReview'), elBtnReset = $('#btnReset');

/* ===== æ¨¡å¼ ===== */
const Modes = [
  { id:'addsub', label:'â‘  æ­£è² æ•¸åŠ æ¸› â•â–' },
  { id:'muldiv', label:'â‘¡ æ­£è² æ•¸ä¹˜é™¤ âœ–ï¸â—' },
  { id:'mixed',  label:'â‘¢ æ­£è² æ•¸åŠ æ¸›ä¹˜é™¤ ğŸ”€' },
  { id:'preced', label:'â‘£ å…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸› âš–ï¸' },
];

/* ===== å·¥å…· ===== */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function showNum(n){ return `(${n})`; } // é¡¯ç¤ºç”¨ï¼šçµ±ä¸€åŠ æ‹¬è™Ÿï¼Œé™ä½çœ‹éŒ¯è™Ÿ
function opEval(op){ return op.replace('Ã—','*').replace('Ã·','/'); }
function playTone(ok=true){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type = ok ? 'sine' : 'square';
  o.frequency.value = ok ? 880 : 220;
  o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
  o.start();
  const d = ok?0.12:0.18;
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+d);
  o.stop(ctx.currentTime+d+0.01);
}
function updateStats(){
  const total = state.history.length;
  const correct = state.history.filter(h=>h.correct).length;
  const rate = total? Math.round(correct*100/total):0;
  elQCount.textContent = total; elQCorrect.textContent = correct; elQRate.textContent = rate+'%';
  elScore.textContent = state.score; elStreak.textContent = state.streak;
  elProgressFill.style.width = Math.min(100, Math.round((total/PROGRESS_TARGET)*100))+'%';
  elModeLabel.textContent = state.mode ? (Modes.find(m=>m.id===state.mode)?.label || 'â€”') : 'â€”';
}

/* ===== è¦å‰‡ï¼šåªæ”¯æ´ ( ) èˆ‡ [ ]ï¼Œå†åš * /ï¼Œå† + -ï¼ˆå·¦â†’å³ï¼‰ ===== */
function evalWithBrackets(exprDisplay){
  // å°‡é¡¯ç¤ºå¼è½‰ç‚ºå¯ eval çš„å­—ä¸²ï¼š[] è¦–ç‚º ()
  let s = exprDisplay.replace(/\s+/g,'').replace(/Ã—/g,'*').replace(/Ã·/g,'/');
  s = s.replace(/\[/g,'(').replace(/\]/g,')');
  // å®‰å…¨æ±‚å€¼ï¼šåƒ…å…è¨±æ•¸å­—èˆ‡ + - * / () è² è™Ÿ
  if(/[^0-9+\-*/().]/.test(s)) return NaN;
  try{ return Function(`"use strict";return (${s});`)(); } catch(e){ return NaN; }
}

/* ===== é¡Œç›®ç”¢ç”Ÿï¼ˆåƒ…ç”¨ ()ã€[]ï¼‰ ===== */
function makeRecord(displayExpr, evalExpr, answer, structure){
  return {displayExpr, evalExpr, answer, user:null, correct:null, explain:null, structure};
}

// â‘  åŠ æ¸›
