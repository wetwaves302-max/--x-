<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’ï½œå¯æ„›ç‰ˆ</title>
  <meta name="description" content="æ­£è² æ•¸åŠ æ¸›ä¹˜é™¤ã€é‹ç®—é †åºç·´ç¿’ï¼›å«è¨ˆåˆ†ã€éŸ³æ•ˆã€éŒ¯é¡Œè¨ºæ–·èˆ‡é¡é¡Œè¤‡ç¿’ï¼›æ‰‹æ©Ÿå‹å–„ã€‚">
  <style>
    :root{
      --bg:#fff8fb;
      --card:#ffffff;
      --primary:#ff88b3;
      --primary-2:#ffd4e4;
      --text:#333;
      --muted:#777;
      --good:#2e7d32;
      --bad:#c62828;
      --accent:#7c4dff;
      --shadow:0 10px 25px rgba(255,136,179,0.15);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family: ui-rounded, "Segoe UI", system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, var(--bg), #fff);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, #fff, var(--bg));
      padding:10px 12px 6px; box-shadow:0 4px 12px rgba(0,0,0,0.04);
    }
    .wrap{max-width:960px; margin:0 auto; padding:14px;}
    .brand{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
    }
    .brand .logo{
      width:40px; height:40px; border-radius:12px; background:var(--primary-2);
      display:grid; place-items:center; font-size:22px; box-shadow:var(--shadow);
    }
    .brand h1{font-size:18px; margin:0;}
    .brand p{margin:0; color:var(--muted); font-size:13px;}
    .bar{
      width:100%; height:10px; background:#f0f0f0; border-radius:999px; overflow:hidden; margin-top:10px;
    }
    .bar .fill{
      height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#ffa1c5);
      transition:width .35s ease; border-radius:999px;
    }
    .stats{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:#444; font-size:13px;
    }
    .chip{
      background:#fff; padding:6px 10px; border-radius:999px; box-shadow:var(--shadow);
    }
    .grid{
      display:grid; gap:14px; grid-template-columns:1fr; margin-top:14px;
    }
    @media(min-width:900px){ .grid{ grid-template-columns: 260px 1fr; } }
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
    }
    .section-title{font-weight:700; margin:0 0 8px; font-size:16px;}
    .modes{ display:flex; flex-wrap:wrap; gap:8px; }
    .mode-btn{
      border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow);
      font-size:14px; cursor:pointer; transition:transform .05s ease;
    }
    .mode-btn.active{ background:var(--primary); color:#fff; }
    .mode-btn:active{ transform:scale(0.98); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .problem{
      font-size:28px; font-weight:800; letter-spacing:.5px; padding:10px 14px; border-radius:14px;
      background:linear-gradient(180deg,#fff,#fff2f6); box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; min-height:72px;
    }
    .answer-area{ display:grid; grid-template-columns:1fr; gap:10px; }
    .answer-input{
      width:100%; font-size:20px; padding:12px 14px; border-radius:12px;
      border:2px solid #eee; outline:none;
    }
    .answer-input:focus{border-color:var(--primary);}
    .keypad{
      display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;
    }
    .key{
      padding:12px 10px; border:none; border-radius:12px; background:#fff; box-shadow:var(--shadow);
      font-size:18px; cursor:pointer;
    }
    .key:active{ transform:scale(0.98); }
    .key.primary{ background:var(--primary); color:#fff; }
    .controls{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn{
      border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow);
      font-size:14px; cursor:pointer;
    }
    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.good{ background:#e6f4ea; color:var(--good); }
    .btn.bad{ background:#fdecea; color:var(--bad); }
    .feedback{
      border-left:6px solid var(--primary); background:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow);
      line-height:1.6; font-size:15px;
    }
    .hint{ color:#5c6bc0; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{
      display:inline-block; padding:4px 8px; background:var(--primary-2); border-radius:999px; font-size:12px;
      margin-right:6px;
    }
    .footer{
      text-align:center; color:var(--muted); padding:16px 0 40px; font-size:12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#fff; box-shadow:var(--shadow);
    }
    .shake{ animation:shake .3s linear; }
    @keyframes shake{
      0%{transform:translateX(0)} 25%{transform:translateX(-3px)} 50%{transform:translateX(3px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">ğŸŒ¸</div>
        <div>
          <h1>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’</h1>
          <p>æº«é¦¨å¯æ„›ãƒ»æ‰‹æ©Ÿå„ªå…ˆãƒ»å«ç›²é»è¨ºæ–·èˆ‡é¡é¡Œè¤‡ç¿’ âœ¨</p>
        </div>
      </div>
      <div class="bar" aria-label="progress"><div id="progressFill" class="fill" style="width:0%"></div></div>
      <div class="stats" id="stats">
        <span class="chip">é¡Œæ•¸ï¼š<b id="qCount">0</b></span>
        <span class="chip">æ­£ç¢ºï¼š<b id="qCorrect">0</b></span>
        <span class="chip">æ­£ç¢ºç‡ï¼š<b id="qRate">0%</b></span>
        <span class="chip">åˆ†æ•¸ï¼š<b id="score">0</b></span>
        <span class="chip">é€£å°ï¼š<b id="streak">0</b> ğŸ”¥</span>
        <span class="chip badge">æ¨¡å¼ï¼š<b id="modeLabel">â€”</b></span>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šæ¨¡å¼èˆ‡è¨­å®š -->
    <section class="card">
      <h2 class="section-title">ç·´ç¿’ä¸»é¡Œ</h2>
      <div class="modes" id="modes">
        <!-- JS ç”Ÿæˆ -->
      </div>
      <hr style="border:none;height:1px;background:#f2f2f2;margin:14px 0;">
      <h2 class="section-title">å°è¨­å®š</h2>
      <div class="row" style="gap:6px 10px">
        <span class="pill">é¡Œåº«ç¯„åœï¼šâˆ’20ï½20ï¼ˆä¹˜é™¤è‡ªå‹•æŒ‘æ•´ï¼‰</span>
        <span class="pill">æ¯é¡Œ +10 / ç­”éŒ¯ âˆ’5</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnReset">é‡ç½®çµ±è¨ˆ</button>
        <button class="btn" id="btnReview" title="éŒ¯é¡Œè¤‡ç¿’ï¼ˆæœƒå‡ºåŒçµæ§‹é¡é¡Œï¼‰">é–‹å§‹éŒ¯é¡Œè¤‡ç¿’</button>
        <span class="muted" id="reviewBadge">ï¼ˆç›®å‰éŒ¯é¡Œï¼š0ï¼‰</span>
      </div>
      <p class="muted" style="margin-top:8px">ğŸ’¡ã€ŒéŒ¯é¡Œè¤‡ç¿’ã€ï¼šå…ˆé¡¯ç¤ºç›²é»ï¼Œå†å‡ºåŒçµæ§‹é¡é¡Œï¼Œå¹«ä½ è£œå¼·æ¦‚å¿µã€‚</p>
    </section>

    <!-- å³ï¼šä½œç­”å€ -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div class="problem" id="problem">è«‹å…ˆé¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œ ğŸ‘ˆ</div>
        <div class="row" style="gap:6px">
          <button class="btn" id="btnPrev" disabled>ä¸Šä¸€é¡Œ</button>
          <button class="btn" id="btnNext" disabled>ä¸‹ä¸€é¡Œ</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr; margin-top:12px">
        <div class="answer-area">
          <input id="answer" class="answer-input" inputmode="numeric" placeholder="åœ¨é€™è£¡è¼¸å…¥ç­”æ¡ˆï¼ˆå¯ç”¨ä¸‹æ–¹éµç›¤ï¼‰" />
          <div class="keypad" id="keypad">
            <!-- 0-9ã€è² è™Ÿã€æ¸…é™¤ã€é€€æ ¼ã€é€å‡º -->
          </div>
          <div class="controls">
            <button class="btn" id="btnSkip">ç•¥é</button>
            <button class="btn primary" id="btnSubmit">é€å‡º</button>
          </div>
          <div id="feedback" class="feedback" style="display:none"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Â© 2025 æ­£è² æ•¸å°å®‡å®™ Â· ç‚ºå­¸ç¿’åŠ æ²¹ ğŸ’—</div>

  <script>
    /***************
     * å¯èª¿æ•´åƒæ•¸  *
     ***************/
    const SCORE_CORRECT = 10;
    const SCORE_WRONG = 5; // æ‰£åˆ†ç”¨
    const PROGRESS_TARGET = 20; // é€²åº¦æ¢æ»¿æ ¼çš„åŸºæº–é¡Œæ•¸ï¼Œå¯è‡ªè¡Œèª¿æ•´

    /***************
     * ç‹€æ…‹ç®¡ç†     *
     ***************/
    const state = {
      mode: null,
      history: [], // {expr, answer, user, correct, explain}
      pointer: -1, // ç›®å‰é¡Œç›®æŒ‡æ¨™ï¼ˆå¯ç”¨ã€Œä¸Šä¸€é¡Œ/ä¸‹ä¸€é¡Œã€ç€è¦½ï¼‰
      score: 0,
      streak: 0,
      reviewQueue: [], // éŒ¯é¡Œçµæ§‹ä½‡åˆ—
    };

    const Modes = [
      { id:'addsub', label:'â‘  æ­£è² æ•¸åŠ æ¸› â•â–' },
      { id:'muldiv', label:'â‘¡ æ­£è² æ•¸ä¹˜é™¤ âœ–ï¸â—' },
      { id:'mixed',  label:'â‘¢ æ­£è² æ•¸å››å‰‡æ··åˆ ğŸ”€' },
      { id:'preced', label:'â‘£ å…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸› âš–ï¸' },
    ];

    /***************
     * å·¥å…·å‡½å¼     *
     ***************/
    const $ = sel => document.querySelector(sel);
    const elModes = $('#modes');
    const elProblem = $('#problem');
    const elAnswer = $('#answer');
    const elKeypad = $('#keypad');
    const elFeedback = $('#feedback');

    const elQCount = $('#qCount');
    const elQCorrect = $('#qCorrect');
    const elQRate = $('#qRate');
    const elScore = $('#score');
    const elStreak = $('#streak');
    const elModeLabel = $('#modeLabel');
    const elProgressFill = $('#progressFill');
    const elReviewBadge = $('#reviewBadge');

    const elBtnPrev = $('#btnPrev');
    const elBtnNext = $('#btnNext');
    const elBtnReset = $('#btnReset');
    const elBtnReview = $('#btnReview');
    const elBtnSkip = $('#btnSkip');
    const elBtnSubmit = $('#btnSubmit');

    function clampInt(n){ return (n|0); }
    function randInt(a,b){ return clampInt(Math.floor(Math.random()*(b-a+1))+a); }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function playTone(ok=true){
      // WebAudio ç°¡æ˜“éŸ³æ•ˆï¼ˆç„¡éœ€å¤–éƒ¨æª”æ¡ˆï¼‰
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = ok ? 'sine' : 'square';
      o.frequency.value = ok ? 880 : 220;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      o.start();
      const dur = ok ? 0.12 : 0.18;
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
      o.stop(ctx.currentTime+dur+0.01);
    }

    function updateStats(){
      const total = state.history.length;
      const correct = state.history.filter(h=>h.correct).length;
      const rate = total? Math.round(correct*100/total):0;
      elQCount.textContent = total;
      elQCorrect.textContent = correct;
      elQRate.textContent = rate + '%';
      elScore.textContent = state.score;
      elStreak.textContent = state.streak;
      const fill = Math.min(100, Math.round((total/PROGRESS_TARGET)*100));
      elProgressFill.style.width = fill + '%';
      elReviewBadge.textContent = `ï¼ˆç›®å‰éŒ¯é¡Œï¼š${state.reviewQueue.length}ï¼‰`;
      elModeLabel.textContent = state.mode ? Modes.find(m=>m.id===state.mode).label : 'â€”';
      // æŒä¹…åŒ–
      localStorage.setItem('int_arith_state', JSON.stringify(state, (k,v)=> k==='history' ? v.slice(-200) : v)); // é™åˆ¶æ­·å²é•·åº¦
    }

    function loadPersist(){
      try{
        const s = JSON.parse(localStorage.getItem('int_arith_state')||'null');
        if(!s) return;
        Object.assign(state, s);
        updateStats();
      }catch(e){}
    }

    /*****************
     * é¡Œç›®ç”¢ç”Ÿå™¨     *
     *****************/
    function genAddSub(){
      const a = randInt(-20,20);
      const b = randInt(-20,20);
      const op = choice(['+','-']);
      const expr = `${a} ${op} ${b}`;
      const answer = op==='+' ? a+b : a-b;
      return { type:'addsub', expr, answer, structure:{kind:'bin', signA:Math.sign(a), signB:Math.sign(b), op} };
    }
    function genMulDiv(){
      // ä¹˜é™¤ï¼šé¿å…é™¤ä»¥ 0ï¼Œä¸”è®“çµæœå¤šç‚ºæ•´æ•¸
      let b = 0;
      while(b===0) b = randInt(-12,12);
      const aBase = randInt(-12,12);
      const op = choice(['Ã—','Ã·']);
      let a, answer;
      if(op==='Ã—'){
        a = aBase;
        answer = a*b;
      }else{
        // è®“ (a Ã· b) ç‚ºæ•´æ•¸ï¼šå…ˆé¸çµæœèˆ‡é™¤æ•¸ï¼Œå›æ¨è¢«é™¤æ•¸
        const res = randInt(-12,12) || 1;
        answer = res;
        a = res*b;
      }
      const expr = `${a} ${op} ${b}`;
      return { type:'muldiv', expr, answer, structure:{kind:'bin', signA:Math.sign(a), signB:Math.sign(b), op} };
    }
    function genMixed(){
      // å…©æ­¥æ··åˆï¼š (a op1 b) op2 cï¼Œå¯èƒ½åŒ…å«ä¹˜é™¤èˆ‡åŠ æ¸›
      const ops = ['+','-','Ã—','Ã·'];
      let op1 = choice(ops), op2 = choice(ops);
      // ç›¡é‡é¿å…é€£çºŒé™¤æ³•é€ æˆåˆ†æ•¸ï¼Œç¨å¾®æ§åˆ¶ï¼š
      if(op1==='Ã·') op2 = choice(['+','-','Ã—']);
      let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
      if(b===0 && op1==='Ã·') b=choice([-3,-2,-1,1,2,3]);
      if(c===0 && op2==='Ã·') c=choice([-3,-2,-1,1,2,3]);

      // è¨ˆç®—æ™‚ä¾ç…§æ­£å¸¸å„ªå…ˆåº
      const val = (x,op,y)=>{
        if(op==='+') return x+y;
        if(op==='-') return x-y;
        if(op==='Ã—') return x*y;
        if(op==='Ã·') return (y===0? NaN : x/y);
      };
      // ç‚ºäº†é¿å…å°æ•¸ï¼šè‹¥æœ‰é™¤æ³•ï¼Œå›æ¨æ•´æ•¸
      if(op1==='Ã·'){ // ä¿è­‰ a å¯ä»¥è¢« b æ•´é™¤
        let res = randInt(-10,10) || 1;
        a = res * (b || 1);
      }
      if(op2==='Ã·'){
        // å…ˆè¨ˆç®— left = a op1 bï¼Œç¢ºä¿å¯æ•´é™¤
        let left = val(a,op1,b);
        if(left===undefined || isNaN(left)) left = 0;
        let res2 = randInt(-10,10) || 1;
        c = (c===0? 1 : Math.abs(c)) * Math.sign(c||1);
        // è®“ left å¯è¢« c æ•´é™¤ï¼šleft = res2 * c
        c = c || 1;
        left = res2 * c;
        // å›æ¨ a ä»¥æ»¿è¶³ left = a op1 b
        // ç°¡åŒ–ï¼šæ”¹é¸æ“‡æ²’æœ‰é™¤æ³•çš„ op1ï¼Œä»¥å…éåº¦è¤‡é›œ
        op1 = choice(['+','-','Ã—']);
        if(op1==='+'){ a = left - b; }
        else if(op1==='-'){ a = left + b; }
        else if(op1==='Ã—'){ a = (b===0? left : (left/ (b||1))); if(!Number.isInteger(a)) { a = left; b = 1; } }
      }

      // æœ€çµ‚ç­”æ¡ˆä»¥å¯¦éš›å„ªå…ˆåºè¨ˆç®—
      function evalExpr(a,op1,b,op2,c){
        const step1 = (op1==='Ã—'||op1==='Ã·') ? val(a,op1,b) : null;
        const step2 = (op2==='Ã—'||op2==='Ã·') ? val((step1!==null? step1 : a), (step1!==null? op2 : op1==='Ã—'||op1==='Ã·'? op2: op2), (step1!==null? c : (op1==='Ã—'||op1==='Ã·'? c : b))) : null;
        // æ›´ç°¡æ½”ï¼šç›´æ¥ç”¨æ¨™æº–å„ªå…ˆåº
        const toVal = (x)=>x;
        const exprJS = `${a} ${op1.replace('Ã—','*').replace('Ã·','/')} ${b} ${op2.replace('Ã—','*').replace('Ã·','/')} ${c}`;
        const ans = Function(`"use strict";return (${exprJS});`)();
        return ans;
      }
      const answer = evalExpr(a,op1,b,op2,c);
      const expr = `${a} ${op1} ${b} ${op2} ${c}`;
      return { type:'mixed', expr, answer, structure:{kind:'tri', op1, op2, signs:[Math.sign(a),Math.sign(b),Math.sign(c)]} };
    }
    function genPrecedence(){
      // ç„¡æ‹¬è™Ÿè¡¨é”å¼ï¼Œå¼·èª¿å…ˆä¹˜é™¤å¾ŒåŠ æ¸›ï¼š a (+/-) b (Ã—/Ã·) c
      let a = randInt(-15,15), b = randInt(-10,10), c = randInt(-10,10);
      let op1 = choice(['+','-']);
      let op2 = choice(['Ã—','Ã·']);
      if(op2==='Ã·'){ if(c===0) c = choice([-3,-2,-1,1,2,3]); }
      // è®“ bÃ—c æˆ– bÃ·c ç”¢ç”Ÿæ•´æ•¸
      if(op2==='Ã—'){
        // ok
      }else{
        // ç¢ºä¿ b/c ç‚ºæ•´æ•¸ï¼šå…ˆæŒ‘ä¸€å€‹æ•´æ•¸ resï¼Œå†è¨­å®š b = res*c
        const res = randInt(-10,10) || 1;
        b = res * c;
      }
      const expr = `${a} ${op1} ${b} ${op2} ${c}`;
      const answer = Function(`"use strict";return (${expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/')});`)();
      return { type:'preced', expr, answer, structure:{kind:'preced', op1, op2, signs:[Math.sign(a),Math.sign(b),Math.sign(c)]} };
    }

    function genQuestion(){
      if(state.mode==='addsub') return genAddSub();
      if(state.mode==='muldiv') return genMulDiv();
      if(state.mode==='mixed')  return genMixed();
      if(state.mode==='preced') return genPrecedence();
      return null;
    }

    /*****************
     * ç›²é»è¨ºæ–·       *
     *****************/
    function diagnose(struct, correctAns, userAns){
      // æ ¹æ“šå¸¸è¦‹éŒ¯èª¤æ¨¡å¼çµ¦å‡ºæ·ºç™½èªªæ˜èˆ‡å»ºè­°
      const tips = [];
      const delta = userAns - correctAns;

      function sgn(n){ return n===0? 0 : (n>0? 1:-1); }

      if(struct.kind==='bin'){
        const {op, signA, signB} = struct;
        if(op==='+' || op==='-'){
          // å¸¸è¦‹ï¼šçœ‹éŒ¯ã€Œæ¸›è² æ•¸ã€æˆã€Œæ¸›æ­£æ•¸ã€ï¼›æˆ–æŠŠã€ŒåŠ è² æ•¸ã€ç•¶ã€ŒåŠ æ­£æ•¸ã€
          if(op==='-' && signB===-1 && userAns === (correctAns + 2* Math.abs(struct.B || 0))){
            tips.push('ä½ å¯èƒ½æŠŠã€Œæ¸›è² æ•¸ã€ç•¶æˆäº†ã€Œæ¸›æ­£æ•¸ã€ã€‚æé†’ï¼šæ¸›æ‰è² æ•¸ç­‰æ–¼åŠ ä¸Šæ­£æ•¸ï¼ˆä¾‹ï¼š5 âˆ’ (âˆ’3) = 5 + 3ï¼‰ã€‚');
          }
          if(op==='+' && signB===-1 && userAns === (correctAns + 2* Math.abs(struct.B || 0))){
            tips.push('ä½ å¯èƒ½å¿½ç•¥äº†åŠ æ•¸çš„è² è™Ÿï¼ŒæŠŠã€Œ+ (âˆ’b)ã€çœ‹æˆã€Œ+ bã€ã€‚è«‹ç•™æ„è² è™Ÿè·Ÿåœ¨æ•¸å­—å‰é¢ã€‚');
          }
          // ä¸€èˆ¬å»ºè­°
          tips.push('åŠ æ¸›æ™‚ï¼Œå…ˆåˆ¤æ–·ã€Œæ–¹å‘ã€ï¼Œå†æ¯”è¼ƒå¤§å°ï¼šåŒè™Ÿ â†’ åŠ å¤§æ•¸å¾Œä¿ç•™ç¬¦è™Ÿï¼›ç•°è™Ÿ â†’ å¤§å°ç›¸æ¸›ï¼Œå–è¼ƒå¤§æ•¸çš„ç¬¦è™Ÿã€‚');
        }else{
          // ä¹˜é™¤çš„ç¬¦è™Ÿè¦å‰‡
          const isSignWrong = (sgn(userAns) !== 0) && (sgn(userAns) !== sgn(correctAns));
          if(isSignWrong){
            tips.push('ä½ å¯èƒ½éŒ¯åœ¨ã€Œä¹˜é™¤çš„æ­£è² è™Ÿè¦å‰‡ã€ã€‚åŒè™Ÿå¾—æ­£ã€ç•°è™Ÿå¾—è² ï¼›ï¼ˆâˆ’ï¼‰Ã—ï¼ˆâˆ’ï¼‰=ï¼ˆï¼‹ï¼‰ï¼Œï¼ˆï¼‹ï¼‰Ã·ï¼ˆâˆ’ï¼‰=ï¼ˆâˆ’ï¼‰ã€‚');
          }
          tips.push('å…ˆçœ‹æ­£è² è™Ÿè¦å‰‡ï¼Œå†åšæ•¸å€¼é‹ç®—ï¼›æœ€å¾Œåˆ¥å¿˜äº†æŠŠç¬¦è™Ÿå¸¶å›ç­”æ¡ˆã€‚');
        }
      }else if(struct.kind==='preced'){
        // é‹ç®—é †åº
        tips.push('ä½ å¯èƒ½å¿½ç•¥äº†ã€Œå…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸›ã€çš„é‹ç®—é †åºã€‚è«‹å…ˆç®—ä¹˜é™¤ï¼Œå†æŠŠçµæœå’ŒåŠ æ¸›åˆä½µã€‚');
        tips.push('åœ¨ç´™ä¸Šå¯ä»¥å…ˆæŠŠä¹˜é™¤éƒ¨åˆ†æ¡†èµ·ä¾†è¨ˆç®—ï¼Œæœ€å¾Œä¸€æ¬¡å¯«å‡ºå®Œæ•´å¼å­ã€‚');
      }else{
        // ä¸‰é …æˆ–æ··åˆ
        tips.push('å‡ºç¾å…©å€‹é‹ç®—æ™‚ï¼Œå‹™å¿…å…ˆè™•ç†ä¹˜é™¤ï¼Œå†ç®—åŠ æ¸›ã€‚æ¯æ­¥é©Ÿå¯«æ¸…æ¥šï¼Œä¸­é–“çµæœä¸è¦å¿ƒç®—è·³æ­¥ã€‚');
      }

      // é€šç”¨å»ºè­°
      if(Math.abs(delta)===1){
        tips.push('ä½ çš„ç­”æ¡ˆåªå·® 1ï¼Œå¯èƒ½åœ¨æœ€å¾Œä¸€æ­¥æŠ„å¯«æˆ–åŠ æ¸›æ™‚å‡ºç¾å°å¤±èª¤ï¼Œé‡ç®—ä¸€æ¬¡æœ€å¾Œå…©æ­¥ã€‚');
      }
      tips.push('å°æ’‡æ­¥ï¼šæŠŠè² æ•¸ç”¨æ‹¬è™ŸåŒ…èµ·ä¾†ï¼ˆä¾‹å¦‚ (âˆ’3)ï¼‰ï¼Œå¯ä»¥æ›´æ¸…æ¥šçœ‹åˆ°é‹ç®—ã€‚');

      return tips;
    }

    /*****************
     * é¡é¡Œç”¢ç”Ÿ       *
     *****************/
    function similarQuestion(struct){
      // ç”¨åŒæ¨£çš„ã€Œçµæ§‹/é‹ç®—ã€å†ç”Ÿä¸€é¡Œä¸åŒæ•¸å­—
      if(struct.kind==='bin'){
        const op = struct.op;
        let a = randInt(-12,12), b = randInt(-12,12);
        // æ§åˆ¶ç¬¦è™Ÿè¶¨å‹¢
        if(struct.signA!==0) a = Math.abs(a)*struct.signA;
        if(struct.signB!==0) b = Math.abs(b)*struct.signB;
        if(op==='Ã·' && b===0) b = choice([-3,-2,-1,1,2,3]);
        const expr = `${a} ${op==='Ã—'?'Ã—': (op==='Ã·'?'Ã·':op)} ${b}`;
        const ans = Function(`"use strict";return (${expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/')});`)();
        return {expr, answer: ans};
      }
      if(struct.kind==='preced'){
        // a (+/-) b (Ã—/Ã·) c
        let a = randInt(-15,15), c = randInt(-10,10);
        let b = randInt(-10,10);
        let {op1, op2, signs} = struct;
        if(op2==='Ã·'){ if(c===0) c=choice([-3,-2,-1,1,2,3]); b = (randInt(-8,8)||1) * c; }
        const expr = `${a} ${op1} ${b} ${op2} ${c}`;
        const ans = Function(`"use strict";return (${expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/')});`)();
        return {expr, answer: ans};
      }
      if(struct.kind==='tri'){
        // a op1 b op2 cï¼ˆä¿ç•™é‹ç®—å­çµæ§‹ï¼‰
        let a = randInt(-10,10), b = randInt(-10,10), c = randInt(-10,10);
        let {op1, op2} = struct;
        if(op1==='Ã·' && b===0) b=choice([-3,-2,-1,1,2,3]);
        if(op2==='Ã·' && c===0) c=choice([-3,-2,-1,1,2,3]);
        const expr = `${a} ${op1} ${b} ${op2} ${c}`;
        const ans = Function(`"use strict";return (${expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/')});`)();
        return {expr, answer: ans};
      }
      // fallback
      const q = genQuestion();
      return {expr:q.expr, answer:q.answer};
    }

    /*****************
     * å‘ˆç¾èˆ‡äº’å‹•     *
     *****************/
    function setProblem(text){
      elProblem.textContent = text;
    }
    function setFeedback(html, good=false, show=true){
      if(!show){ elFeedback.style.display='none'; return; }
      elFeedback.innerHTML = html;
      elFeedback.style.display = 'block';
      if(!good){ elFeedback.classList.add('shake'); setTimeout(()=>elFeedback.classList.remove('shake'), 300); }
    }

    function pushHistory(item){
      state.history.push(item);
      state.pointer = state.history.length - 1;
    }

    function showCurrent(){
      const h = state.history[state.pointer];
      if(!h){ return; }
      setProblem(h.expr);
      elAnswer.value = '';
      setFeedback('', false, false);
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = (state.pointer>=state.history.length-1);
    }

    function newQuestion(fromReview=false){
      if(!state.mode && !fromReview){ return; }
      const q = genQuestion();
      setProblem(q.expr);
      elAnswer.value = '';
      setFeedback('', false, false);
      pushHistory({expr:q.expr, answer:q.answer, user:null, correct:null, explain:null, structure:q.structure});
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = true;
      updateStats();
    }

    function startReview(){
      if(state.reviewQueue.length===0){
        setFeedback('ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯ä»¥è¤‡ç¿’ï¼Œå…ˆåšå¹¾é¡Œå†å›ä¾†å§ ğŸŒ±', true, true);
        return;
      }
      // å–å‡ºä¸€å€‹çµæ§‹ï¼Œå‡ºé¡é¡Œ
      const struct = state.reviewQueue.shift();
      const sim = similarQuestion(struct);
      setProblem(sim.expr + 'ï¼ˆé¡é¡Œï¼‰');
      elAnswer.value = '';
      setFeedback('<span class="hint">é€™é¡Œæ˜¯ä¾ç…§ä½ çš„éŒ¯èª¤é¡å‹å‡ºçš„ã€Œé¡é¡Œã€ã€‚å…ˆä¾æç¤ºæ€è€ƒï¼Œå†è©¦ä¸€æ¬¡ï¼</span>', true, true);
      pushHistory({expr:sim.expr, answer:sim.answer, user:null, correct:null, explain:'ï¼ˆé¡é¡Œç·´ç¿’ï¼‰', structure:struct});
      updateStats();
      elBtnPrev.disabled = (state.pointer<=0);
      elBtnNext.disabled = true;
    }

    function submit(){
      const h = state.history[state.pointer];
      if(!h){ return; }
      const raw = elAnswer.value.trim();
      if(!raw){ elAnswer.focus(); return; }
      const user = Number(raw);
      const correct = (user === h.answer);
      h.user = user;
      h.correct = correct;

      if(correct){
        playTone(true);
        state.score += SCORE_CORRECT;
        state.streak += 1;
        setFeedback(`âœ… <b>ç­”å°äº†ï¼</b> ${h.expr} = <b>${h.answer}</b><br>
        <span class="muted">å¤ªæ£’äº†ï½ç¹¼çºŒä¿æŒï¼</span>`, true, true);
      }else{
        playTone(false);
        state.score -= SCORE_WRONG;
        state.streak = 0;
        const tips = diagnose(h.structure || {kind:'bin'}, h.answer, user);
        h.explain = tips.join('<br>');
        // æ¨å…¥éŒ¯é¡Œçµæ§‹é€²è¤‡ç¿’ä½‡åˆ—
        if(h.structure) state.reviewQueue.push(h.structure);
        setFeedback(`âŒ <b>å¯æƒœï¼</b> æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${h.answer}</b><br><br>
        <b>ç›²é»è¨ºæ–·ï¼š</b><br>${tips.map(t=>`â€¢ ${t}`).join('<br>')}<br><br>
        <span class="hint">ğŸ‘‰ å°ç·´ç¿’ï¼šé»ã€Œé–‹å§‹éŒ¯é¡Œè¤‡ç¿’ã€æœƒå‡ºåŒçµæ§‹çš„é¡é¡Œå–”ï¼</span>`, false, true);
      }
      elBtnNext.disabled = false;
      updateStats();
    }

    /*****************
     * äº‹ä»¶ç¶å®š       *
     *****************/
    // å»ºç«‹æ¨¡å¼æŒ‰éˆ•
    function buildModeButtons(){
      Modes.forEach(m=>{
        const b = document.createElement('button');
        b.className = 'mode-btn';
        b.textContent = m.label;
        b.addEventListener('click', ()=>{
          document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          state.mode = m.id;
          state.streak = 0;
          setFeedback('å·²åˆ‡æ›æ¨¡å¼ï¼Œé–‹å§‹æ–°ä¸€é¡Œå§ï¼', true, true);
          newQuestion();
          updateStats();
        });
        elModes.appendChild(b);
      });
    }

    // å»ºç«‹æ•¸å­—éµç›¤
    function buildKeypad(){
      const keys = [
        '7','8','9','âŒ«',
        '4','5','6','æ¸…é™¤',
        '1','2','3','âˆ’',
        '0','00','Â±','é€å‡º'
      ];
      keys.forEach(k=>{
        const btn = document.createElement('button');
        btn.className = 'key' + (k==='é€å‡º' ? ' primary':'');
        btn.textContent = k;
        btn.addEventListener('click', ()=>{
          if(k==='é€å‡º'){ submit(); return; }
          if(k==='æ¸…é™¤'){ elAnswer.value=''; return; }
          if(k==='âŒ«'){ elAnswer.value = elAnswer.value.slice(0,-1); return; }
          if(k==='âˆ’'){ // æ’å…¥è² è™Ÿ
            if(elAnswer.value.startsWith('-')) return; // åªå…è¨±ä¸€å€‹å‰ç¶´è² è™Ÿ
            elAnswer.value = '-' + elAnswer.value;
            return;
          }
          if(k==='Â±'){
            if(elAnswer.value.startsWith('-')) elAnswer.value = elAnswer.value.slice(1);
            else elAnswer.value = (elAnswer.value? ('-'+elAnswer.value) : '-');
            return;
          }
          // æ•¸å­—
          elAnswer.value += k;
        });
        elKeypad.appendChild(btn);
      });
    }

    // ä¸»è¦æ§åˆ¶æŒ‰éˆ•
    elBtnSubmit.addEventListener('click', submit);
    elBtnSkip.addEventListener('click', ()=>{ newQuestion(); });
    elBtnPrev.addEventListener('click', ()=>{
      if(state.pointer>0){ state.pointer--; showCurrent(); }
    });
    elBtnNext.addEventListener('click', ()=>{
      if(state.pointer < state.history.length-1){ state.pointer++; showCurrent(); }
      else { newQuestion(); }
    });
    elBtnReset.addEventListener('click', ()=>{
      if(confirm('ç¢ºå®šè¦é‡ç½®çµ±è¨ˆèˆ‡é€²åº¦å—ï¼Ÿï¼ˆä¸æœƒåˆªé™¤é¡Œç›®å…§å®¹ï¼‰')){
        state.history=[]; state.pointer=-1; state.score=0; state.streak=0; state.reviewQueue=[];
        setProblem('å·²é‡ç½®ï¼Œè«‹é¸æ“‡ä¸»é¡Œæˆ–æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ã€‚');
        setFeedback('', false, false);
        updateStats();
        elBtnPrev.disabled = true; elBtnNext.disabled = true;
      }
    });
    elBtnReview.addEventListener('click', startReview);

    // éµç›¤ Enter é€å‡º
    elAnswer.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ submit(); }
    });

    // åˆå§‹åŒ–
    buildModeButtons();
    buildKeypad();
    loadPersist();
    updateStats();

    // é¦–æ¬¡æç¤º
    if(!state.mode){
      setFeedback('è«‹å…ˆåœ¨å·¦å´é¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œï¼ˆä¾‹å¦‚ã€Œâ‘  æ­£è² æ•¸åŠ æ¸›ã€ï¼‰ï¼Œå†é–‹å§‹ä½œç­”ã€‚', true, true);
    }else{
      newQuestion();
    }
  </script>
</body>
</html>
