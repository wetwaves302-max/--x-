<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’ï½œå…ˆåŠ æ¸›å¾Œä¹˜é™¤ï¼ˆå«æ‹¬è™Ÿï¼‰</title>
  <meta name="description" content="æ­£è² æ•¸åŠ æ¸›ä¹˜é™¤ã€å…ˆåŠ æ¸›å¾Œä¹˜é™¤ï¼›å«è¨ˆåˆ†ã€éŸ³æ•ˆã€ç›²é»è¨ºæ–·èˆ‡éŒ¯é¡Œé¡é¡Œè¤‡ç¿’ï¼›æ‰‹æ©Ÿå‹å–„ï¼›æ‰€æœ‰ç®—å¼ä¿ç•™( )ã€‚">
  <style>
    :root{
      --bg:#fff8fb; --card:#ffffff; --primary:#ff88b3; --primary-2:#ffd4e4;
      --text:#333; --muted:#777; --good:#2e7d32; --bad:#c62828; --shadow:0 10px 25px rgba(255,136,179,0.15);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{margin:0; font-family:ui-rounded,"Segoe UI",system-ui,-apple-system,"PingFang TC","Noto Sans TC",sans-serif;
      background:linear-gradient(180deg,var(--bg),#fff); color:var(--text);}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,#fff,var(--bg));
      padding:10px 12px 6px; box-shadow:0 4px 12px rgba(0,0,0,0.04);}
    .wrap{max-width:960px; margin:0 auto; padding:14px;}
    .brand{display:flex; gap:10px; align-items:center; padding:8px 10px;}
    .brand .logo{width:40px; height:40px; border-radius:12px; background:var(--primary-2); display:grid; place-items:center; font-size:22px; box-shadow:var(--shadow);}
    .brand h1{margin:0; font-size:18px;}
    .brand p{margin:0; color:var(--muted); font-size:13px;}
    .bar{width:100%; height:10px; background:#f0f0f0; border-radius:999px; overflow:hidden; margin-top:10px;}
    .bar .fill{height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#ffa1c5); transition:width .35s; border-radius:999px;}
    .stats{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; color:#444; font-size:13px;}
    .chip{background:#fff; padding:6px 10px; border-radius:999px; box-shadow:var(--shadow);}
    .grid{display:grid; gap:14px; grid-template-columns:1fr; margin-top:14px;}
    @media(min-width:900px){ .grid{grid-template-columns:260px 1fr;} }
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;}
    .section-title{margin:0 0 8px; font-size:16px; font-weight:700;}
    .modes{display:flex; flex-wrap:wrap; gap:8px;}
    .mode-btn{border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow); font-size:14px; cursor:pointer;}
    .mode-btn.active{background:var(--primary); color:#fff;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .problem{font-size:28px; font-weight:800; letter-spacing:.5px; padding:10px 14px; border-radius:14px;
      background:linear-gradient(180deg,#fff,#fff2f6); box-shadow:var(--shadow); display:flex; align-items:center; justify-content:center; min-height:72px;}
    .answer-area{display:grid; grid-template-columns:1fr; gap:10px;}
    .answer-input{width:100%; font-size:20px; padding:12px 14px; border-radius:12px; border:2px solid #eee; outline:none;}
    .answer-input:focus{border-color:var(--primary);}
    .keypad{display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
    .key{padding:12px 10px; border:none; border-radius:12px; background:#fff; box-shadow:var(--shadow); font-size:18px; cursor:pointer;}
    .key.primary{background:var(--primary); color:#fff;}
    .controls{display:flex; gap:8px; flex-wrap:wrap;}
    .btn{border:none; border-radius:12px; padding:10px 12px; background:#fff; box-shadow:var(--shadow); font-size:14px; cursor:pointer;}
    .btn.primary{background:var(--primary); color:#fff;}
    .feedback{border-left:6px solid var(--primary); background:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); line-height:1.6; font-size:15px;}
    .hint{color:#5c6bc0;} .muted{color:var(--muted); font-size:12px;}
    .footer{text-align:center; color:var(--muted); padding:16px 0 40px; font-size:12px;}
    .shake{animation:shake .3s linear;} @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">ğŸŒ¸</div>
        <div>
          <h1>æ­£è² æ•¸å››å‰‡é‹ç®—ç·´ç¿’ï¼ˆå…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ï¼‰</h1>
          <p>æº«é¦¨å¯æ„›ãƒ»æ‰‹æ©Ÿå„ªå…ˆãƒ»å«ç›²é»è¨ºæ–·èˆ‡é¡é¡Œè¤‡ç¿’ âœ¨ï¼ˆæ‰€æœ‰ç®—å¼ä¿ç•™æ‹¬è™Ÿï¼‰</p>
        </div>
      </div>
      <div class="bar" aria-label="progress"><div id="progressFill" class="fill"></div></div>
      <div class="stats" id="stats">
        <span class="chip">é¡Œæ•¸ï¼š<b id="qCount">0</b></span>
        <span class="chip">æ­£ç¢ºï¼š<b id="qCorrect">0</b></span>
        <span class="chip">æ­£ç¢ºç‡ï¼š<b id="qRate">0%</b></span>
        <span class="chip">åˆ†æ•¸ï¼š<b id="score">0</b></span>
        <span class="chip">é€£å°ï¼š<b id="streak">0</b> ğŸ”¥</span>
        <span class="chip">æ¨¡å¼ï¼š<b id="modeLabel">â€”</b></span>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šæ¨¡å¼èˆ‡è¨­å®š -->
    <section class="card">
      <h2 class="section-title">ç·´ç¿’ä¸»é¡Œ</h2>
      <div class="modes" id="modes"></div>
      <hr style="border:none;height:1px;background:#f2f2f2;margin:14px 0;">
      <h2 class="section-title">å°è¨­å®š</h2>
      <div class="row" style="gap:6px 10px">
        <span class="muted">é¡Œåº«ç¯„åœï¼šâˆ’20ï½20ï¼ˆé™¤æ³•é¿å… 0ã€ç›¡é‡æ•´æ•¸ï¼‰</span>
        <span class="muted">æ¯é¡Œ +10 / ç­”éŒ¯ âˆ’5ï¼›æ‰€æœ‰æ•¸å­—èˆ‡æ­¥é©Ÿä»¥ ( ) é¡¯ç¤º</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnReset">é‡ç½®çµ±è¨ˆ</button>
        <button class="btn" id="btnReview" title="éŒ¯é¡Œè¤‡ç¿’ï¼ˆå‡ºåŒçµæ§‹é¡é¡Œï¼‰">é–‹å§‹éŒ¯é¡Œè¤‡ç¿’</button>
        <span class="muted" id="reviewBadge">ï¼ˆç›®å‰éŒ¯é¡Œï¼š0ï¼‰</span>
      </div>
      <p class="muted" style="margin-top:8px">ğŸ’¡ æœ¬ç‰ˆæ¡ã€Œå…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ã€çš„ç‰¹æ®Šè¦å‰‡ï¼Œé¡Œé¢æœƒç”¨æ‹¬è™Ÿæ¸…æ¥šæ¨™ç¤ºå…ˆç®—çš„åŠ æ¸›ç¾¤çµ„ã€‚</p>
    </section>

    <!-- å³ï¼šä½œç­”å€ -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div class="problem" id="problem">è«‹å…ˆé¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œ ğŸ‘ˆ</div>
        <div class="row" style="gap:6px">
          <button class="btn" id="btnPrev" disabled>ä¸Šä¸€é¡Œ</button>
          <button class="btn" id="btnNext" disabled>ä¸‹ä¸€é¡Œ</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:1fr; margin-top:12px">
        <div class="answer-area">
          <input id="answer" class="answer-input" inputmode="numeric" placeholder="åœ¨é€™è£¡è¼¸å…¥ç­”æ¡ˆï¼ˆå¯ç”¨ä¸‹æ–¹éµç›¤ï¼‰" />
          <div class="keypad" id="keypad"></div>
          <div class="controls">
            <button class="btn" id="btnSkip">ç•¥é</button>
            <button class="btn primary" id="btnSubmit">é€å‡º</button>
          </div>
          <div id="feedback" class="feedback" style="display:none"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Â© 2025 æ­£è² æ•¸å°å®‡å®™ Â· ç‚ºå­¸ç¿’åŠ æ²¹ ğŸ’—</div>

  <script>
    /***************
     * å¯èª¿æ•´åƒæ•¸  *
     ***************/
    const SCORE_CORRECT = 10;
    const SCORE_WRONG = 5;
    const PROGRESS_TARGET = 20;

    /***************
     * ç‹€æ…‹ç®¡ç†     *
     ***************/
    const state = {
      mode: null,
      history: [], // {displayExpr, tokens, answer, user, correct, explain, structure}
      pointer: -1,
      score: 0,
      streak: 0,
      reviewQueue: [],
    };

    const Modes = [
      { id:'addsub', label:'â‘  æ­£è² æ•¸åŠ æ¸› â•â–' },
      { id:'muldiv', label:'â‘¡ æ­£è² æ•¸ä¹˜é™¤ âœ–ï¸â—' },
      { id:'mixed',  label:'â‘¢ æ­£è² æ•¸å››å‰‡æ··åˆ ğŸ”€ï¼ˆå…ˆåŠ æ¸›å¾Œä¹˜é™¤ï¼‰' },
      { id:'preced', label:'â‘£ å…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ âš–ï¸' },
    ];

    /***************
     * å°å·¥å…·       *
     ***************/
    const $ = sel => document.querySelector(sel);
    const elModes = $('#modes'), elProblem = $('#problem'), elAnswer = $('#answer'),
          elKeypad = $('#keypad'), elFeedback = $('#feedback'),
          elQCount = $('#qCount'), elQCorrect = $('#qCorrect'), elQRate = $('#qRate'),
          elScore = $('#score'), elStreak = $('#streak'), elModeLabel = $('#modeLabel'),
          elProgressFill = $('#progressFill'), elReviewBadge = $('#reviewBadge'),
          elBtnPrev = $('#btnPrev'), elBtnNext = $('#btnNext'), elBtnReset = $('#btnReset'),
          elBtnReview = $('#btnReview'), elBtnSkip = $('#btnSkip'), elBtnSubmit = $('#btnSubmit');

    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const isAddSub = op => (op==='+'||op==='-');
    const isMulDiv = op => (op==='Ã—'||op==='Ã·');

    // æ ¼å¼åŒ–ï¼šæ‰€æœ‰æ•¸å­—éƒ½æ”¾åœ¨ ( ) å…§ï¼Œè²¼è¿‘ç´™ç­†
    function showNum(n){ return `(${n})`; }

    // éŸ³æ•ˆ
    function playTone(ok=true){
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = ok ? 'sine' : 'square'; o.frequency.value = ok ? 880 : 220;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      o.start(); const dur = ok ? 0.12 : 0.18;
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
      o.stop(ctx.currentTime+dur+0.01);
    }

    function updateStats(){
      const total = state.history.length;
      const correct = state.history.filter(h=>h.correct).length;
      const rate = total? Math.round(correct*100/total):0;
      elQCount.textContent = total; elQCorrect.textContent = correct; elQRate.textContent = rate + '%';
      elScore.textContent = state.score; elStreak.textContent = state.streak;
      elProgressFill.style.width = Math.min(100, Math.round((total/PROGRESS_TARGET)*100)) + '%';
      elReviewBadge.textContent = `ï¼ˆç›®å‰éŒ¯é¡Œï¼š${state.reviewQueue.length}ï¼‰`;
      elModeLabel.textContent = state.mode ? Modes.find(m=>m.id===state.mode).label : 'â€”';
      localStorage.setItem('int_arith_state_prefsADMD', JSON.stringify(state, (k,v)=> k==='history' ? v.slice(-200) : v));
    }
    (function loadPersist(){
      try{ const s = JSON.parse(localStorage.getItem('int_arith_state_prefsADMD')||'null'); if(s){ Object.assign(state, s); updateStats(); } }catch(e){}
    })();

    /***********************
     * è‡ªè¨‚é‹ç®—è©•åˆ†é‚è¼¯     *
     * è¦å‰‡ï¼šå…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ *
     ***********************/
    // tokens å½¢å¼ï¼š [number, op, number, op, number]ï¼Œop in ['+','-','Ã—','Ã·']
    function evalWithAddFirst(tokens){
      // ç¬¬ä¸€æ®µï¼šå…ˆæŠŠ + / - ç”±å·¦åˆ°å³åšå®Œï¼Œç•™ä¸‹ä¹˜é™¤å¾…å¾Œ
      // ä¾‹ï¼ša + b Ã— c - d â†’ ((a + b) Ã— c) - dï¼Œä½†æˆ‘å€‘ç¬¬ä¸€æ®µåªåˆä½µåŠ æ¸›ï¼ša' Ã— c - d
      let arr = tokens.slice();
      // åˆä½µæ‰€æœ‰åŠ æ¸›
      for(let i=1; i<arr.length-1; ){
        const op = arr[i];
        if(isAddSub(op)){
          const left = arr[i-1], right = arr[i+1];
          const val = (op==='+') ? (left + right) : (left - right);
          // æ›¿æ›æˆä¸€å€‹æ•¸å­—
          arr.splice(i-1, 3, val);
          // i å›åˆ°ä¸Šä¸€å€‹ä½ç½®ç¹¼çºŒæª¢æŸ¥
          i = Math.max(1, i-2);
        }else{
          i += 2;
        }
      }
      // ç¬¬äºŒæ®µï¼šå‰©ä¸‹åªæœƒæœ‰ä¹˜é™¤ï¼Œå¾å·¦åˆ°å³
      let result = arr[0];
      for(let i=1; i<arr.length; i+=2){
        const op = arr[i], right = arr[i+1];
        if(op==='Ã—') result = result * right;
        else if(op==='Ã·'){
          if(right===0) return NaN;
          result = result / right;
        }
      }
      return result;
    }

    function buildDisplayFromTokens(tokens){
      // ä¾è¦å‰‡åŠ ä¸Šæ‹¬è™Ÿï¼šå…ˆæŠŠæ‰€æœ‰ã€ŒåŠ æ¸›ç¾¤çµ„ã€åŠ æ‹¬è™Ÿ
      // ä¸‰æ•¸å…©é‹ç®—çš„æƒ…æ³ï¼Œå®¹æ˜“è¾¨è­˜ï¼š
      if(tokens.length===5){
        const [a,op1,b,op2,c] = tokens;
        // è‹¥å­˜åœ¨åŠ æ¸›èˆ‡ä¹˜é™¤æ··åˆï¼Œå°‡åŠ æ¸›ç¾¤çµ„æ‹¬èµ·ä¾†
        if(isAddSub(op1) && isMulDiv(op2)){
          // (a Â± b) Ã—/Ã· c
          return `(${showNum(a)} ${op1} ${showNum(b)}) ${op2} ${showNum(c)}`;
        }
        if(isMulDiv(op1) && isAddSub(op2)){
          // a Ã—/Ã· (b Â± c)
          return `${showNum(a)} ${op1} (${showNum(b)} ${op2} ${showNum(c)})`;
        }
        // åŒé¡å‹ï¼ˆéƒ½åŠ æ¸› æˆ– éƒ½ä¹˜é™¤ï¼‰ï¼šä»ç”¨ ( ) åŒ…ä½æ¯å€‹æ•¸ï¼Œç¶­æŒä¸€è‡´è¦–è¦º
        return `${showNum(a)} ${op1} ${showNum(b)} ${op2} ${showNum(c)}`;
      }
      // äºŒå…ƒ
      if(tokens.length===3){
        const [a,op,b] = tokens;
        return `${showNum(a)} ${op} ${showNum(b)}`;
      }
      // Fallbackï¼šé€æ®µ
      return tokens.map(t => (typeof t==='number' ? showNum(t) : t)).join(' ');
    }

    function recordFromTokens(tokens, structure){
      // åè¦†å˜—è©¦ç›´åˆ°ç­”æ¡ˆç‚ºæ•´æ•¸ï¼ˆé¿å…å°æ•¸å¹²æ“¾ï¼‰
      let ans = evalWithAddFirst(tokens);
      let tries = 0;
      while((!Number.isFinite(ans) || !Number.isInteger(ans)) && tries<20){
        // ç°¡å–®å›é€€ï¼šé‡æ–°ç”ŸæˆåŒçµæ§‹çš„æ–°æ•¸å­—
        tokens = regenSameShape(tokens);
        ans = evalWithAddFirst(tokens);
        tries++;
      }
      const displayExpr = buildDisplayFromTokens(tokens);
      return {displayExpr, tokens, answer: ans, user:null, correct:null, explain:null, structure};
    }

    function regenSameShape(tokens){
      // ä¿æŒé‹ç®—å­ä¸è®Šï¼Œæ›æ•¸å­—ï¼ˆç¶­æŒæ­£/è² å‚¾å‘ï¼‰
      const newT = tokens.slice();
      for(let i=0;i<newT.length;i+=2){
        const old = newT[i];
        let n = randInt(-12,12);
        if(old!==0) n = Math.abs(n)*Math.sign(old);
        if(i>0 && newT[i-1]==='Ã·' && n===0) n = choice([-3,-2,-1,1,2,3]);
        newT[i] = n;
      }
      return newT;
    }

    /*****************
     * é¡Œç›®ç”¢ç”Ÿå™¨     *
     *****************/
    function genAddSub(){
      const a = randInt(-20,20), b = randInt(-20,20);
      const op = choice(['+','-']);
      return recordFromTokens([a,op,b], {kind:'bin',op,a,b,rule:'add-first'});
    }

    function genMulDiv(){
      let a = randInt(-12,12), b = randInt(-12,12);
      if(b===0) b = choice([-3,-2,-1,1,2,3]);
      const op = choice(['Ã—','Ã·']);
      if(op==='Ã·'){ a = (randInt(-10,10)||1)*b; } // è®“çµæœå¤šåŠç‚ºæ•´æ•¸
      return recordFromTokens([a,op,b], {kind:'bin',op,a,b,rule:'add-first'});
    }

    function genMixed(){
      // å…©æ­¥é‹ç®—ï¼Œç¢ºä¿æœ‰ã€ŒåŠ æ¸›ã€èˆ‡ã€Œä¹˜é™¤ã€å…±åŒå‡ºç¾ï¼Œæ‰èƒ½ç·´åˆ°è¦å‰‡
      // æ¨¡å¼ A: (a Â± b) Ã—/Ã· c
      // æ¨¡å¼ B: a Ã—/Ã· (b Â± c)
      const pattern = choice(['A','B']);
      if(pattern==='A'){
        let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
        const op1 = choice(['+','-']); let op2 = choice(['Ã—','Ã·']);
        if(op2==='Ã·'){ if(c===0) c = choice([-3,-2,-1,1,2,3]); }
        return recordFromTokens([a,op1,b,op2,c], {kind:'tri',shape:'(aÂ±b)op c',op1,op2,a,b,c,rule:'add-first'});
      }else{
        let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
        const op1 = choice(['Ã—','Ã·']); let op2 = choice(['+','-']);
        if(op1==='Ã·'){ if(b===0) b = choice([-3,-2,-1,1,2,3]); a = (randInt(-8,8)||1)*b; }
        return recordFromTokens([a,op1,b,op2,c], {kind:'tri',shape:'a op (bÂ±c)',op1,op2,a,b,c,rule:'add-first'});
      }
    }

    function genPrecedence(){ // å°ˆç·´ã€Œå…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ã€
      // ç›¡é‡ç”Ÿæˆä¸€å®šå«ä¸€å€‹åŠ æ¸›èˆ‡ä¸€å€‹ä¹˜é™¤
      return genMixed();
    }

    function genQuestion(){
      if(state.mode==='addsub') return genAddSub();
      if(state.mode==='muldiv') return genMulDiv();
      if(state.mode==='mixed')  return genMixed();
      if(state.mode==='preced') return genPrecedence();
      return null;
    }

    /*****************
     * ç›²é»è¨ºæ–·       *
     *****************/
    function diagnose(struct, correctAns, userAns){
      const tips = [];
      if(struct.kind==='bin'){
        if(struct.op==='+' || struct.op==='-'){
          tips.push('åŠ æ¸›ï¼šåŒè™Ÿç›¸åŠ ä¿ç¬¦è™Ÿï¼›ç•°è™Ÿå…ˆæ¯”å¤§å°å†ç›¸æ¸›ï¼Œå–è¼ƒå¤§æ•¸çš„ç¬¦è™Ÿã€‚æŠŠè² æ•¸éƒ½å¯«æˆ (âˆ’3) é€™ç¨®æ¨£å­æ›´æ¸…æ¥šã€‚');
        }else{
          tips.push('ä¹˜é™¤å‰ï¼Œå…ˆæŠŠç¬¦è™Ÿè¦å‰‡æƒ³æ¸…æ¥šï¼šåŒè™Ÿå¾—æ­£ã€ç•°è™Ÿå¾—è² ï¼›å†ç®—æ•¸å€¼ã€‚');
        }
      }else{
        tips.push('æœ¬é¡Œè¦å‰‡æ˜¯ã€Œå…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ã€ã€‚è«‹æŠŠè¦å…ˆç®—çš„åŠ æ¸›éƒ¨åˆ†ç”¨æ‹¬è™Ÿæ‹¬èµ·ä¾†ï¼Œä¾‹å¦‚ï¼š(a + b) Ã— c æˆ– a Ã· (b âˆ’ c)ã€‚');
        tips.push('æ­¥é©Ÿå»ºè­°ï¼šâ‘  å…ˆç®—æ‹¬è™Ÿè£¡çš„åŠ æ¸›ï¼›â‘¡ å†åšä¹˜é™¤ï¼›â‘¢ æœ€å¾Œæª¢æŸ¥ç¬¦è™Ÿã€‚');
      }
      if(Number.isFinite(userAns) && Number.isFinite(correctAns) && Math.abs(userAns - correctAns)===1){
        tips.push('ä½ çš„ç­”æ¡ˆåªå·® 1ï¼Œå¯èƒ½æ˜¯æœ€å¾Œä¸€æ­¥æŠ„å¯«æˆ–åŠ æ¸›æ™‚çš„å°å¤±èª¤ï¼Œé‡ç®—æœ€å¾Œå…©æ­¥ã€‚');
      }
      tips.push('å°æ’‡æ­¥ï¼šæ‰€æœ‰è² æ•¸èˆ‡ä¸­é–“çµæœéƒ½ç”¨æ‹¬è™Ÿï¼ˆå¦‚ (âˆ’4)ã€((âˆ’4)+7)ï¼‰ï¼Œèƒ½å¤§å¹…é™ä½çœ‹éŒ¯è™Ÿã€‚');
      return tips;
    }

    /*****************
     * é¡é¡Œç”¢ç”Ÿ       *
     *****************/
    function similarQuestion(struct){
      // ä¾åŸçµæ§‹å‡ºæ–°æ•¸å­—
      if(struct.kind==='bin'){
        let a = randInt(-12,12), b = randInt(-12,12);
        if(struct.op==='Ã·'){ if(b===0) b = choice([-3,-2,-1,1,2,3]); a = (randInt(-8,8)||1)*b; }
        return recordFromTokens([a,struct.op,b], struct);
      }
      if(struct.kind==='tri'){
        if(struct.shape==='(aÂ±b)op c'){
          let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
          if(struct.op2==='Ã·'){ if(c===0) c = choice([-3,-2,-1,1,2,3]); }
          return recordFromTokens([a,struct.op1,b,struct.op2,c], struct);
        }else{ // a op (bÂ±c)
          let a = randInt(-12,12), b = randInt(-12,12), c = randInt(-12,12);
          if(struct.op1==='Ã·'){ if(b===0) b = choice([-3,-2,-1,1,2,3]); a = (randInt(-8,8)||1)*b; }
          return recordFromTokens([a,struct.op1,b,struct.op2,c], struct);
        }
      }
      // fallback
      const q = genQuestion();
      return q;
    }

    /*****************
     * å‘ˆç¾èˆ‡äº’å‹•     *
     *****************/
    function setProblem(text){ elProblem.textContent = text; }
    function setFeedback(html, good=false, show=true){
      if(!show){ elFeedback.style.display='none'; return; }
      elFeedback.innerHTML = html; elFeedback.style.display = 'block';
      if(!good){ elFeedback.classList.add('shake'); setTimeout(()=>elFeedback.classList.remove('shake'),300); }
    }
    function pushHistory(item){ state.history.push(item); state.pointer = state.history.length-1; }
    function showCurrent(){
      const h = state.history[state.pointer]; if(!h) return;
      setProblem(h.displayExpr); elAnswer.value=''; setFeedback('',false,false);
      elBtnPrev.disabled = (state.pointer<=0); elBtnNext.disabled = (state.pointer>=state.history.length-1);
    }
    function newQuestion(){
      if(!state.mode) return;
      const q = genQuestion();
      setProblem(q.displayExpr); elAnswer.value=''; setFeedback('',false,false);
      pushHistory(q); elBtnPrev.disabled = (state.pointer<=0); elBtnNext.disabled = true; updateStats();
    }
    function startReview(){
      if(state.reviewQueue.length===0){ setFeedback('ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯ä»¥è¤‡ç¿’ï¼Œå…ˆåšå¹¾é¡Œå†å›ä¾†å§ ğŸŒ±', true, true); return; }
      const struct = state.reviewQueue.shift();
      const sim = similarQuestion(struct);
      setProblem(sim.displayExpr + 'ï¼ˆé¡é¡Œï¼‰'); elAnswer.value='';
      setFeedback('<span class="hint">é€™é¡Œä¾ä½ çš„éŒ¯èª¤é¡å‹å‡ºã€Œé¡é¡Œã€ã€‚å…ˆæŒ‰è¦å‰‡æŠŠè¦å…ˆç®—çš„åŠ æ¸›åœˆèµ·ä¾†å†ç®—ï¼</span>', true, true);
      pushHistory(sim); updateStats(); elBtnPrev.disabled=(state.pointer<=0); elBtnNext.disabled=true;
    }

    function submit(){
      const h = state.history[state.pointer]; if(!h) return;
      const raw = elAnswer.value.trim(); if(!raw){ elAnswer.focus(); return; }
      const user = Number(raw); const correct = (user===h.answer);
      h.user = user; h.correct = correct;

      if(correct){
        playTone(true); state.score += SCORE_CORRECT; state.streak += 1;
        setFeedback(`âœ… <b>ç­”å°äº†ï¼</b> ${h.displayExpr} = <b>${h.answer}</b><br><span class="muted">å¤ªæ£’äº†ï½ç¹¼çºŒä¿æŒï¼</span>`, true, true);
      }else{
        playTone(false); state.score -= SCORE_WRONG; state.streak = 0;
        const tips = diagnose(h.structure||{kind:'tri'}, h.answer, user); h.explain = tips.join('<br>');
        if(h.structure) state.reviewQueue.push(h.structure);
        setFeedback(`âŒ <b>å¯æƒœï¼</b> æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${h.answer}</b><br><br><b>ç›²é»è¨ºæ–·ï¼š</b><br>${tips.map(t=>'â€¢ '+t).join('<br>')}<br><br><span class="hint">ğŸ‘‰ é»ã€Œé–‹å§‹éŒ¯é¡Œè¤‡ç¿’ã€å‡ºåŒçµæ§‹é¡é¡Œï¼</span>`, false, true);
      }
      elBtnNext.disabled = false; updateStats();
    }

    /*****************
     * äº‹ä»¶ç¶å®š       *
     *****************/
    // æ¨¡å¼æŒ‰éˆ•
    (function buildModeButtons(){
      Modes.forEach(m=>{
        const b=document.createElement('button'); b.className='mode-btn'; b.textContent=m.label;
        b.addEventListener('click',()=>{
          document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active'); state.mode=m.id; state.streak=0;
          setFeedback('å·²åˆ‡æ›æ¨¡å¼ï¼Œé–‹å§‹æ–°ä¸€é¡Œå§ï¼', true, true); newQuestion(); updateStats();
        });
        elModes.appendChild(b);
      });
    })();

    // æ•¸å­—éµç›¤ï¼ˆå«è² è™Ÿï¼‰
    (function buildKeypad(){
      ['7','8','9','âŒ«','4','5','6','æ¸…é™¤','1','2','3','âˆ’','0','00','Â±','é€å‡º'].forEach(k=>{
        const btn=document.createElement('button'); btn.className='key'+(k==='é€å‡º'?' primary':''); btn.textContent=k;
        btn.addEventListener('click',()=>{
          if(k==='é€å‡º') return submit();
          if(k==='æ¸…é™¤'){ elAnswer.value=''; return; }
          if(k==='âŒ«'){ elAnswer.value = elAnswer.value.slice(0,-1); return; }
          if(k==='âˆ’'){ if(!elAnswer.value.startsWith('-')) elAnswer.value='-'+elAnswer.value; return; }
          if(k==='Â±'){ elAnswer.value = elAnswer.value.startsWith('-') ? elAnswer.value.slice(1) : (elAnswer.value?('-'+elAnswer.value):'-'); return; }
          elAnswer.value += k;
        });
        elKeypad.appendChild(btn);
      });
    })();

    elBtnSubmit.addEventListener('click', submit);
    elBtnSkip.addEventListener('click', newQuestion);
    elBtnPrev.addEventListener('click', ()=>{ if(state.pointer>0){ state.pointer--; showCurrent(); } });
    elBtnNext.addEventListener('click', ()=>{ if(state.pointer<state.history.length-1){ state.pointer++; showCurrent(); } else { newQuestion(); } });
    elBtnReset.addEventListener('click', ()=>{
      if(confirm('ç¢ºå®šè¦é‡ç½®çµ±è¨ˆèˆ‡é€²åº¦å—ï¼Ÿ')){
        state.history=[]; state.pointer=-1; state.score=0; state.streak=0; state.reviewQueue=[];
        setProblem('å·²é‡ç½®ï¼Œè«‹é¸æ“‡ä¸»é¡Œæˆ–æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ã€‚'); setFeedback('',false,false); updateStats();
        elBtnPrev.disabled=true; elBtnNext.disabled=true;
      }
    });
    elBtnReview.addEventListener('click', startReview);
    elAnswer.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });

    // åˆå§‹åŒ–æç¤º
    if(!state.mode){
      setFeedback('è«‹å…ˆåœ¨å·¦å´é¸æ“‡ä¸€å€‹ç·´ç¿’ä¸»é¡Œï¼ˆä¾‹å¦‚ã€Œâ‘¢ å››å‰‡æ··åˆã€æˆ–ã€Œâ‘£ å…ˆåŠ æ¸›ï¼Œå¾Œä¹˜é™¤ã€ï¼‰ï¼Œå†é–‹å§‹ä½œç­”ã€‚', true, true);
    }
  </script>
</body>
</html>
