<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ­£è² æ•¸å››å‰‡é‹ç®—ï½œ()â†’[]â†’{} â†’ ä¹˜é™¤ â†’ åŠ æ¸›ï¼ˆå«è¨ˆæ™‚èˆ‡é›£åº¦ï¼‰</title>
<meta name="description" content="éµå¾ªå…ˆå°æ‹¬è™Ÿ()ã€å†ä¸­æ‹¬è™Ÿ[]ã€å†å¤§æ‹¬è™Ÿ{}ï¼Œæ¥è‘—å…ˆä¹˜é™¤å¾ŒåŠ æ¸›ï¼ŒåŒå±¤ç”±å·¦åˆ°å³ï¼›æ”¯æ´è¨ˆæ™‚æ¨¡å¼èˆ‡é›£åº¦æ˜Ÿç­‰ï¼›å«å³æ™‚å›é¥‹èˆ‡éŒ¯é¡Œé¡é¡Œè¤‡ç¿’ã€‚">
<style>
  :root{
    --bg:#fff8fb; --card:#fff; --primary:#ff88b3; --primary2:#ffd4e4;
    --text:#333; --muted:#777; --good:#2e7d32; --bad:#c62828;
    --shadow:0 10px 25px rgba(255,136,179,.15); --r:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-rounded,"Segoe UI",system-ui,-apple-system,"PingFang TC","Noto Sans TC",sans-serif;background:linear-gradient(180deg,var(--bg),#fff);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,var(--bg));padding:10px 12px 6px;box-shadow:0 4px 12px rgba(0,0,0,.04)}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  .brand{display:flex;gap:10px;align-items:center;padding:8px 10px}
  .logo{width:40px;height:40px;border-radius:12px;background:var(--primary2);display:grid;place-items:center;font-size:22px;box-shadow:var(--shadow)}
  .brand h1{margin:0;font-size:18px}
  .brand p{margin:0;color:var(--muted);font-size:13px}

  .principles{margin-top:8px;padding:12px;border-radius:14px;background:#fff;box-shadow:var(--shadow);border-left:6px solid var(--primary)}
  .principles h2{margin:0 0 8px;font-size:16px}
  .principles ol{margin:0;padding-left:20px}
  .pill{display:inline-block;margin-right:8px;margin-top:8px;padding:4px 10px;border-radius:999px;background:#ffe5ef;font-size:12px}

  .bar{width:100%;height:10px;background:#f0f0f0;border-radius:999px;overflow:hidden;margin-top:10px}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--primary),#ffa1c5);transition:width .35s;border-radius:999px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;color:#444;font-size:13px}
  .chip{background:#fff;padding:6px 10px;border-radius:999px;box-shadow:var(--shadow)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;box-shadow:var(--shadow)}
  .timer{font-weight:700;color:#c62828}

  .grid{display:grid;gap:14px;grid-template-columns:1fr;margin-top:14px}
  @media(min-width:900px){.grid{grid-template-columns:280px 1fr}}

  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
  .section-title{margin:0 0 8px;font-size:16px;font-weight:700}

  .problem{font-size:26px;font-weight:800;letter-spacing:.5px;padding:12px 14px;border-radius:14px;
           background:linear-gradient(180deg,#fff,#fff2f6);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;min-height:72px;word-break:break-word}
  .answer-area{display:grid;grid-template-columns:1fr;gap:10px}
  .answer-input{width:100%;font-size:20px;padding:12px 14px;border-radius:12px;border:2px solid #eee;outline:none}
  .answer-input:focus{border-color:var(--primary)}
  .keypad{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .key{padding:12px 10px;border:none;border-radius:12px;background:#fff;box-shadow:var(--shadow);font-size:18px;cursor:pointer}
  .key.primary{background:var(--primary);color:#fff}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:none;border-radius:12px;padding:10px 12px;background:#fff;box-shadow:var(--shadow);font-size:14px;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .feedback{border-left:6px solid var(--primary);background:#fff;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);line-height:1.6;font-size:15px}
  .step{padding:6px 10px;background:#fafafa;border-radius:10px;margin:6px 0;border:1px dashed #eee}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#f7f7f7;border:1px solid #e5e5e5;border-radius:6px;padding:0 6px}
  .muted{color:#777;font-size:12px}
  .shake{animation:shake .3s linear}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  .footer{text-align:center;color:var(--muted);padding:16px 0 40px;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">ğŸŒ¸</div>
      <div>
        <h1>æ­£è² æ•¸å››å‰‡é‹ç®—ï¼ˆå«(),[],{}ï¼›è¨ˆæ™‚ï¼‹é›£åº¦ï¼‰</h1>
        <p>è¦å‰‡ï¼šå…ˆ()â†’[]â†’{} â†’ ä¹˜é™¤ â†’ åŠ æ¸›ï¼ˆåŒå±¤ç”±å·¦è‡³å³ï¼‰</p>
      </div>
    </div>

    <!-- å››å‰‡é‹ç®—åŸå‰‡ï¼šæ¸…æ¥šå¯è¦‹ -->
    <div class="principles">
      <h2>å››å‰‡é‹ç®—åŸå‰‡ï¼ˆè«‹ç‰¢è¨˜ï¼ï¼‰</h2>
      <ol>
        <li><b>å…ˆç®—æ‹¬è™Ÿ</b>ï¼šå…ˆå° <span class="kbd">()</span> â†’ å†ä¸­ <span class="kbd">[]</span> â†’ æœ€å¾Œå¤§ <span class="kbd">{}</span>ï¼ˆç”±å…§å‘å¤–ï¼‰ã€‚</li>
        <li>æ‹¬è™Ÿè™•ç†å®Œå¾Œï¼Œ<b>å…ˆä¹˜é™¤</b>ï¼ˆå·¦ â†’ å³ï¼‰ã€‚</li>
        <li>æœ€å¾Œåš<b>åŠ æ¸›</b>ï¼ˆå·¦ â†’ å³ï¼‰ã€‚</li>
      </ol>
      <span class="pill">å°æŠ€å·§ï¼šæŠŠè² æ•¸å¯«æˆ <span class="kbd">(-3)</span> å¯é¿å…çœ‹éŒ¯è™Ÿ</span>
      <span class="pill">æ¯åŒ–ç°¡ä¸€æ­¥ï¼Œé‡æ–°å¯«ä¸€è¡Œï¼Œé¿å…åœ¨è…¦ä¸­åŒæ™‚è™•ç†å¤ªå¤šæ­¥</span>
    </div>

    <div class="bar" aria-label="progress"><div id="progressFill" class="fill"></div></div>
    <div class="stats">
      <span class="chip">é¡Œæ•¸ï¼š<b id="qCount">0</b></span>
      <span class="chip">æ­£ç¢ºï¼š<b id="qCorrect">0</b></span>
      <span class="chip">æ­£ç¢ºç‡ï¼š<b id="qRate">0%</b></span>
      <span class="chip">åˆ†æ•¸ï¼š<b id="score">0</b></span>
      <span class="chip">é€£å°ï¼š<b id="streak">0</b> ğŸ”¥</span>
      <span class="badge">æ¨¡å¼ï¼š<b id="modeLabel">ä¸€èˆ¬ç·´ç¿’</b></span>
      <span class="badge" id="timerBadge">â± è¨ˆæ™‚ï¼š<span class="timer" id="timerText">æœªé–‹å§‹</span></span>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- å·¦ï¼šæ§åˆ¶ -->
  <section class="card">
    <h2 class="section-title">æ§åˆ¶èˆ‡è¨­å®š</h2>
    <div class="controls" style="margin-bottom:8px">
      <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ</button>
      <button class="btn primary" id="btnSubmit">é€å‡º</button>
    </div>
    <div class="controls">
      <button class="btn" id="btnTimer60">é–‹å§‹è¨ˆæ™‚æŒ‘æˆ°ï¼ˆ60ç§’ï¼‰</button>
      <button class="btn" id="btnTimer120">é–‹å§‹è¨ˆæ™‚æŒ‘æˆ°ï¼ˆ120ç§’ï¼‰</button>
      <button class="btn" id="btnStopTimer">åœæ­¢è¨ˆæ™‚</button>
    </div>
    <div class="controls" style="margin-top:8px">
      <button class="btn" id="btnReview">é–‹å§‹éŒ¯é¡Œè¤‡ç¿’</button>
      <button class="btn" id="btnReset">é‡ç½®çµ±è¨ˆ</button>
    </div>
    <p class="muted" style="margin-top:6px">è¨ˆåˆ†ï¼šç­”å° +10ã€ç­”éŒ¯ âˆ’5ï¼›è¨ˆæ™‚æ¨¡å¼ä¸‹æ™‚é–“åˆ°æœƒè‡ªå‹•çµç®—ã€‚</p>
  </section>

  <!-- å³ï¼šä½œç­” -->
  <section class="card">
    <div class="problem" id="problem">è«‹æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ï¼ˆæ¯é¡Œæœƒé¡¯ç¤º â­ é›£åº¦ï¼‰</div>

    <div class="answer-area">
      <input id="answer" class="answer-input" inputmode="numeric" placeholder="è¼¸å…¥ç­”æ¡ˆå¾ŒæŒ‰ã€Œé€å‡ºã€æˆ– Enter"/>
      <div class="keypad" id="keypad"></div>
      <div id="feedback" class="feedback" style="display:none"></div>
    </div>
  </section>
</main>

<div class="footer">Â© 2025 æ­£è² æ•¸å°å®‡å®™ Â· è¦å‰‡æ¸…æ™°ï¼Œè¨ˆç®—ä¸è¿·è·¯ ğŸ’—</div>

<script>
/* ==== å¯èª¿æ•´åƒæ•¸ ==== */
const SCORE_CORRECT = 10;
const SCORE_WRONG = 5;
const PROGRESS_TARGET = 20;

/* ==== ç‹€æ…‹ ==== */
const state = {
  history:[], // {expr, answer, steps, user, correct, structure, stars}
  pointer:-1,
  score:0, streak:0,
  timerMode:false, timeLeft:0, timer:null,
  reviewQueue:[],
};

const $ = s=>document.querySelector(s);
const elProblem = $('#problem'), elAnswer = $('#answer'), elFeedback = $('#feedback');
const elQCount = $('#qCount'), elQCorrect = $('#qCorrect'), elQRate = $('#qRate');
const elScore = $('#score'), elStreak = $('#streak'), elProgressFill = $('#progressFill');
const elTimerText = $('#timerText'), elModeLabel = $('#modeLabel');

/* ==== å·¥å…· ==== */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function showNum(n){ return `(${n})`; } // æ›¸å¯«é¢¨æ ¼çµ±ä¸€
function playTone(ok=true){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type = ok ? 'sine' : 'square'; o.frequency.value = ok ? 880 : 220;
  o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
  o.start(); const dur = ok ? 0.12 : 0.18; g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
  o.stop(ctx.currentTime+dur+0.01);
}
function updateStats(){
  const total = state.history.length;
  const correct = state.history.filter(h=>h.correct).length;
  const rate = total? Math.round(correct*100/total):0;
  elQCount.textContent = total; elQCorrect.textContent = correct; elQRate.textContent = rate+'%';
  elScore.textContent = state.score; elStreak.textContent = state.streak;
  elProgressFill.style.width = Math.min(100, Math.round((total/PROGRESS_TARGET)*100))+'%';
  localStorage.setItem('int_arith_nested_rules_v1', JSON.stringify(state,(k,v)=>k==='history'?v.slice(-200):v));
}

/* ==== è¦å‰‡è§£æå™¨ ====
   å…ˆ() â†’ [] â†’ {}ï¼ŒåŒå±¤ç”±å…§å‘å¤–ï¼›å† ä¹˜é™¤ï¼ˆå·¦â†’å³ï¼‰ï¼›å† åŠ æ¸›ï¼ˆå·¦â†’å³ï¼‰
   å›å‚³ {value, steps}
*/
function evalByRules(exprInput){
  let expr = exprInput.replace(/\s+/g,'');
  const steps = [];
  const pushStep = (title, e=expr)=>steps.push({title, expr:e});

  function reduceBracketType(open, close, label){
    while(true){
      let stack=[], found=false, L=-1, R=-1;
      for(let i=0;i<expr.length;i++){
        if(expr[i]===open){ stack.push(i); }
        else if(expr[i]===close){
          if(stack.length){
            L = stack.pop();
            if(stack.length===0){ R=i; found=true; break; }
          }
        }
      }
      if(!found) break;
      const inside = expr.slice(L+1,R);
      const inner = evalFlat(inside); // å…§å±¤ä¸è·¨å±¤æ‹¬è™Ÿ
      expr = expr.slice(0,L) + inner.value + expr.slice(R+1);
      pushStep(`è¨ˆç®—${label} ${open}â€¦${close}`, expr);
    }
  }

  // å¹³é¢å±¤ï¼ˆç„¡ä»»ä½•æ‹¬è™Ÿï¼‰è¨ˆç®—ï¼šä¹˜é™¤â†’åŠ æ¸›ï¼ˆå·¦â†’å³ï¼‰
  function tokenize(s){
    const tokens=[]; let i=0;
    while(i<s.length){
      const ch = s[i];
      if(/[0-9]/.test(ch) || (ch==='-' && (i===0 || /[+\-Ã—Ã·*/]/.test(s[i-1])))){
        let j=i+1; while(j<s.length && /[0-9]/.test(s[j])) j++;
        tokens.push(parseInt(s.slice(i,j),10)); i=j;
      }else if('Ã—Ã·*/+-'.includes(ch)){ tokens.push(ch); i++; }
      else { i++; }
    }
    return tokens;
  }
  function reduceLeftToRight(tokens, ops, title){
    for(let i=1;i<tokens.length-1;){
      const op=tokens[i];
      if(ops.includes(op)){
        const a=Number(tokens[i-1]), b=Number(tokens[i+1]);
        let v=0;
        if(op==='Ã—'||op==='*') v=a*b;
        else if(op==='Ã·'||op==='/'){ if(b===0) return {err:'é™¤ä»¥ 0'}; v=a/b; }
        else if(op==='+') v=a+b;
        else if(op==='-') v=a-b;
        tokens.splice(i-1,3,v);
        pushStep(title, tokens.join(' '));
        i=Math.max(1,i-2);
      }else i+=2;
    }
    return {ok:true,tokens};
  }
  function evalFlat(s){
    // s ç„¡å¤–å±¤æ‹¬è™Ÿï¼ˆä»å¯èƒ½å«è² è™Ÿï¼‰
    const t0=tokenize(s);
    const rMD = reduceLeftToRight(t0, ['Ã—','Ã·','*','/'], 'å…ˆåšä¹˜é™¤ï¼ˆå·¦â†’å³ï¼‰'); if(rMD.err) return {value:NaN, steps:steps.concat([{title:'éŒ¯èª¤',expr:rMD.err}])};
    const rAS = reduceLeftToRight(rMD.tokens, ['+','-'], 'å†åšåŠ æ¸›ï¼ˆå·¦â†’å³ï¼‰'); if(rAS.err) return {value:NaN, steps:steps.concat([{title:'éŒ¯èª¤',expr:rAS.err}])};
    return {value:Number(rAS.tokens[0]||0)};
  }

  // å…ˆè™•ç†æ‹¬è™Ÿï¼š() â†’ [] â†’ {}
  reduceBracketType('(',')','å°æ‹¬è™Ÿ');
  reduceBracketType('[',']','ä¸­æ‹¬è™Ÿ');
  reduceBracketType('{','}','å¤§æ‹¬è™Ÿ');

  // å†è™•ç†å¹³é¢
  const finalVal = evalFlat(expr).value;
  pushStep('å®Œæˆ', String(finalVal));
  return {value:finalVal, steps};
}

/* ==== é¡Œç›®ç”¢ç”Ÿå™¨ï¼ˆä¿æ•´æ•¸ç­”æ¡ˆï¼‰ ==== */
function makeRecord(expr, structure, stars){
  const {value, steps} = evalByRules(expr);
  if(!Number.isFinite(value) || !Number.isInteger(value)) return makeRecord(genExprByStructure(structure,true), structure, stars);
  return {expr, answer:value, steps, user:null, correct:null, structure, stars};
}
function nNZ(){ return choice([-12,-9,-8,-6,-5,-4,-3,-2,-1,1,2,3,4,5,6,8,9,12]); }
function nS(){ return randInt(-9,9); }
function wrap(type, inner){
  if(type==='()') return `(${inner})`;
  if(type==='[]') return `[${inner}]`;
  if(type==='{}') return `{${inner}}`;
  return inner;
}

function genEasy(){ // â­: äºŒå…ƒåŠ æ¸›
  const a=nS(), b=nS();
  const op=choice(['+','-']);
  const expr = `${wrap('()', showNum(a)+' '+op+' '+showNum(b))}`;
  return makeRecord(`â­ã€€${expr}`, {kind:'binAS',op}, 'â­');
}
function genMedium(){ // â­â­: å«ä¹˜é™¤ï¼ˆä¿æ•´æ•¸ï¼‰
  const op=choice(['Ã—','Ã·']);
  let b=nNZ(), a=nS();
  if(op==='Ã·'){ a=(randInt(-8,8)||1)*b; }
  const expr = `${wrap('()', showNum(a)+' '+op+' '+showNum(b))}`;
  return makeRecord(`â­â­ã€€${expr}`, {kind:'binMD',op}, 'â­â­');
}
function genHard(){ // â­â­â­: æ··åˆèˆ‡å·¢ç‹€æ‹¬è™Ÿ
  // å½¢æ…‹1ï¼š (aÂ±b) Ã— [cÂ±d]
  const a=nS(), b=nS(), c=nS(), d=nS();
  const op1=choice(['+','-']), op2=choice(['+','-']), midOp=choice(['Ã—','Ã·']);
  let left = wrap('()', showNum(a)+' '+op1+' '+showNum(b));
  let right;
  if(midOp==='Ã—'){
    right = wrap('[]', showNum(c)+' '+op2+' '+showNum(d));
  }else{
    // Ã· æ™‚è®“å³å´ç‚ºæ•´æ•¸ï¼šè¨­ [cÂ±d] = kï¼ˆé0ï¼‰
    const k = nNZ(); right = wrap('[]', showNum(k)+' '+op2+' '+showNum(0)); // å…ˆæ”¾çµæ§‹ï¼Œå†æ”¹é€ 
    // ç‚ºäº†ç°¡å–®ï¼Œæ”¹ç”¨ (aÂ±b)Ã—(cÂ±d) æˆ– { (aÂ±b) Ã— [p] }ï¼Œé€™è£¡é¿å…å¤ªè¤‡é›œçš„æ•´é™¤ä¿®è£œ
    right = wrap('[]', showNum(c)+' '+op2+' '+showNum(d));
  }
  let core = `${left} ${choice(['Ã—','Ã·','+','-'])} ${right}`;
  // å¤–å±¤å†åŒ…ä¸€å±¤ {} æˆ–ä¸åŒ…
  const expr = Math.random()<0.5 ? wrap('{}', core) : core;
  return makeRecord(`â­â­â­ã€€${expr}`, {kind:'mixed'}, 'â­â­â­');
}
function genQuestion(){
  const picker = choice(['easy','medium','hard','hard']); // ç¨å¾®æé«˜å‡ºç¾æ··åˆ/æ‹¬è™Ÿæ¯”ä¾‹
  if(picker==='easy') return genEasy();
  if(picker==='medium') return genMedium();
  return genHard();
}

/* åŒçµæ§‹é¡é¡Œ */
function genExprByStructure(structure){
  switch(structure?.kind){
    case 'binAS': return genEasy().expr.replace(/^â­ã€€/,'');
    case 'binMD': return genMedium().expr.replace(/^â­â­ã€€/,'');
    case 'mixed': return genHard().expr.replace(/^â­â­â­ã€€/,'');
    default: return genHard().expr.replace(/^â­â­â­ã€€/,'');
  }
}
function similarQuestion(struct){
  const expr = genExprByStructure(struct);
  const stars = (struct?.kind==='binAS')?'â­':(struct?.kind==='binMD')?'â­â­':'â­â­â­';
  return makeRecord(`${stars}ã€€${expr}`, struct, stars);
}

/* ==== å‘ˆç¾ & äº’å‹• ==== */
function setProblem(t){ elProblem.textContent = t; }
function setFeedback(html, good=false, show=true){
  if(!show){ elFeedback.style.display='none'; return; }
  elFeedback.innerHTML = html; elFeedback.style.display='block';
  if(!good){ elFeedback.classList.add('shake'); setTimeout(()=>elFeedback.classList.remove('shake'),300); }
}
function pushHistory(item){ state.history.push(item); state.pointer = state.history.length-1; }
function newQuestion(){
  const q = genQuestion();
  setProblem(q.expr); elAnswer.value=''; setFeedback('',false,false);
  pushHistory(q); updateStats();
}
function startReview(){
  if(state.reviewQueue.length===0){ setFeedback('ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯è¤‡ç¿’ï¼Œå…ˆåšå¹¾é¡Œå†å›ä¾†å§ ğŸŒ±', true, true); return; }
  const struct = state.reviewQueue.shift();
  const sim = similarQuestion(struct);
  setProblem(sim.expr + 'ï¼ˆé¡é¡Œï¼‰'); elAnswer.value='';
  setFeedback('<span class="kbd">æç¤ºï¼šå…ˆ()â†’[]â†’{}ï¼Œå† ä¹˜é™¤ï¼Œæœ€å¾Œ åŠ æ¸›ï¼ˆå·¦â†’å³ï¼‰ã€‚</span>', true, true);
  pushHistory(sim); updateStats();
}

/* ==== è¨ˆæ™‚æ¨¡å¼ ==== */
function startTimer(sec){
  if(state.timer) clearInterval(state.timer);
  state.timerMode = true; state.timeLeft = sec;
  elTimerText.textContent = `${state.timeLeft} ç§’`;
  state.timer = setInterval(()=>{
    state.timeLeft--;
    elTimerText.textContent = `${state.timeLeft} ç§’`;
    if(state.timeLeft<=0){
      clearInterval(state.timer); state.timer=null; state.timerMode=false;
      elTimerText.textContent = 'çµæŸ';
      setFeedback(`âŒ› æ™‚é–“åˆ°ï¼å®Œæˆ <b>${state.history.length}</b> é¡Œï¼Œæ­£ç¢º <b>${state.history.filter(h=>h.correct).length}</b> é¡Œï¼Œå¾—åˆ† <b>${state.score}</b> åˆ†ã€‚`, false, true);
    }
  },1000);
}
function stopTimer(){
  if(state.timer){ clearInterval(state.timer); state.timer=null; }
  state.timerMode=false; elTimerText.textContent='æœªé–‹å§‹';
}

/* ==== è¨ºæ–·ï¼ˆå³æ™‚å»ºè­°ï¼‰ ==== */
function diagnose(h, user){
  const tips=[];
  const e = h.expr;
  if(/[()\[\]\{\}]/.test(e)){
    tips.push('å…ˆè™•ç†æ‹¬è™Ÿå±¤æ¬¡ï¼šå…ˆå° () â†’ ä¸­ [] â†’ å¤§ {}ï¼Œæ¯ç®—å®Œä¸€å±¤å†å¾€å¤–ã€‚');
  }
  if(e.includes('Ã—') || e.includes('Ã·')){
    tips.push('æ‹¬è™Ÿå¾Œå…ˆåšä¹˜é™¤ï¼ˆç”±å·¦åˆ°å³ï¼‰ï¼Œæœ€å¾Œæ‰åŠ æ¸›ã€‚');
  }
  // å·®ä¸€é»é¼“å‹µ
  if(Number.isFinite(user) && Number.isFinite(h.answer) && Math.abs(user-h.answer)===1){
    tips.push('åªå·® 1ï¼æª¢æŸ¥æœ€å¾Œä¸€æ­¥åŠ æ¸›æ˜¯å¦æŠ„éŒ¯æˆ–çœ‹éŒ¯ç¬¦è™Ÿã€‚');
  }
  tips.push('å°æ’‡æ­¥ï¼šæŠŠè² æ•¸å¯«æˆ (-3)ï¼Œä¸­é–“çµæœä¹Ÿç”¨æ‹¬è™Ÿæ¨™å‡ºï¼Œèƒ½å¤§å¹…é™ä½çœ‹éŒ¯è™Ÿã€‚');
  // æ­¥é©ŸåŒ–ç°¡
  const stepHtml = h.steps?.map((s,i)=>`<div class="step"><b>Step ${i+1}ï½œ${s.title}</b><br><span class="kbd">${s.expr}</span></div>`).join('') || '';
  return {tips, stepHtml};
}

/* ==== é€å‡º ==== */
function submit(){
  const h = state.history[state.pointer]; if(!h) return;
  const raw = elAnswer.value.trim(); if(!raw){ elAnswer.focus(); return; }
  const user = Number(raw); const ok = (user===h.answer);
  h.user = user; h.correct = ok;

  if(ok){
    playTone(true); state.score += SCORE_CORRECT; state.streak += 1;
    setFeedback(`âœ… <b>ç­”å°äº†ï¼</b> ${h.expr} = <b>${h.answer}</b><br><span class="muted">å¤ªæ£’äº†ï½è¦å‰‡æŒæ¡æ­£ç¢ºã€‚</span><br>${diagnose(h,user).stepHtml}`, true, true);
  }else{
    playTone(false); state.score -= SCORE_WRONG; state.streak = 0;
    if(h.structure) state.reviewQueue.push(h.structure);
    const dx = diagnose(h, user);
    setFeedback(
      `âŒ <b>å¯æƒœï¼</b> æ­£ç¢ºç­”æ¡ˆï¼š<b>${h.answer}</b><br>
       <div class="step"><b>é¡Œç›®ï¼š</b><br><span class="kbd">${h.expr}</span></div>
       <div class="step"><b>è¦å‰‡æé†’ï¼š</b> å…ˆ <span class="kbd">()</span> â†’ <span class="kbd">[]</span> â†’ <span class="kbd">{}</span> â†’ ä¹˜é™¤ â†’ åŠ æ¸›ï¼ˆå·¦â†’å³ï¼‰</div>
       ${dx.stepHtml}
       <b>çµ¦ä½ çš„å»ºè­°ï¼š</b><br>â€¢ ${dx.tips.join('<br>â€¢ ')}`,
      false, true
    );
  }
  updateStats();
}

/* ==== äº‹ä»¶ç¶å®š ==== */
$('#btnNext').addEventListener('click', newQuestion);
$('#btnSubmit').addEventListener('click', submit);
$('#btnTimer60').addEventListener('click', ()=>{ stopTimer(); state.history=[]; state.pointer=-1; state.score=0; state.streak=0; updateStats(); startTimer(60); newQuestion(); elModeLabel.textContent='è¨ˆæ™‚ 60 ç§’'; });
$('#btnTimer120').addEventListener('click', ()=>{ stopTimer(); state.history=[]; state.pointer=-1; state.score=0; state.streak=0; updateStats(); startTimer(120); newQuestion(); elModeLabel.textContent='è¨ˆæ™‚ 120 ç§’'; });
$('#btnStopTimer').addEventListener('click', ()=>{ stopTimer(); elModeLabel.textContent='ä¸€èˆ¬ç·´ç¿’'; });

$('#btnReview').addEventListener('click', startReview);
$('#btnReset').addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šè¦é‡ç½®çµ±è¨ˆèˆ‡é€²åº¦å—ï¼Ÿ')){
    stopTimer();
    Object.assign(state,{history:[],pointer:-1,score:0,streak:0,reviewQueue:[]});
    setProblem('å·²é‡ç½®ï¼Œè«‹æŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ï¼ˆæœƒé¡¯ç¤º â­ é›£åº¦ï¼‰ã€‚'); setFeedback('',false,false); updateStats();
    elModeLabel.textContent='ä¸€èˆ¬ç·´ç¿’';
  }
});
elAnswer.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });

/* ==== æ•¸å­—éµç›¤ï¼ˆè¡Œå‹•è£ç½®å‹å–„ï¼‰ ==== */
(function buildKeypad(){
  const keys=['7','8','9','âŒ«','4','5','6','æ¸…é™¤','1','2','3','âˆ’','0','00','Â±','é€å‡º'];
  const pad = $('#keypad');
  keys.forEach(k=>{
    const b=document.createElement('button'); b.className='key'+(k==='é€å‡º'?' primary':''); b.textContent=k;
    b.addEventListener('click',()=>{
      if(k==='é€å‡º') return submit();
      if(k==='æ¸…é™¤'){ elAnswer.value=''; return; }
      if(k==='âŒ«'){ elAnswer.value = elAnswer.value.slice(0,-1); return; }
      if(k==='âˆ’'){ if(!elAnswer.value.startsWith('-')) elAnswer.value='-'+elAnswer.value; return; }
      if(k==='Â±'){ elAnswer.value = elAnswer.value.startsWith('-')? elAnswer.value.slice(1) : (elAnswer.value?('-'+elAnswer.value):'-'); return; }
      elAnswer.value += k;
    });
    pad.appendChild(b);
  });
})();

/* ==== åˆå§‹åŒ– ==== */
setFeedback('è«‹é–±è®€ä¸Šæ–¹ã€Œå››å‰‡é‹ç®—åŸå‰‡ã€ï¼Œç„¶å¾ŒæŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹ã€‚', true, true);
updateStats();
</script>
</body>
</html>
